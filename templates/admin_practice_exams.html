<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LGS Deneme Takip - Admin</title>
    <link rel="stylesheet" href="/static/css/admin-modern.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <style>
        .result-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        .result-modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0,0,0,0.25);
            text-align: center;
        }
        .result-modal-icon {
            font-size: 60px;
            margin-bottom: 15px;
        }
        .result-modal-title {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 15px;
            color: #374151;
        }
        .result-modal-message {
            font-size: 1em;
            color: #4b5563;
            line-height: 1.6;
            white-space: pre-line;
            margin-bottom: 20px;
            text-align: left;
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
        }
        .result-modal-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 14px 50px;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .result-modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .result-modal.success .result-modal-icon { color: #10b981; }
        .result-modal.error .result-modal-icon { color: #ef4444; }
        .result-modal.info .result-modal-icon { color: #3b82f6; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family), 'Segoe UI', sans-serif;
            background: var(--gray-50);
        }
        .header {
            background: var(--gradient-primary);
            color: white;
            padding: 20px 24px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 1.6em; font-weight: 700; }
        .btn-back {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.4);
            padding: 10px 22px;
            border-radius: var(--radius-lg);
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            transition: all var(--transition-fast);
        }
        .btn-back:hover { background: rgba(255,255,255,0.3); transform: translateY(-1px); }
        .container {
            max-width: 1400px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .card h2 {
            color: #374151;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #374151;
            font-weight: 500;
        }
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 14px;
        }
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102,126,234,0.4); }
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        .btn-warning:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(245,158,11,0.4); }
        .chart-container {
            position: relative;
            height: 350px;
            margin-bottom: 20px;
        }
        .student-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        .student-card {
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        .student-card:hover {
            background: #e5e7eb;
            border-color: #667eea;
        }
        .student-card.selected {
            background: #dbeafe;
            border-color: #3b82f6;
        }
        .student-card .name {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }
        .student-card .info {
            font-size: 0.85em;
            color: #6b7280;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #93c5fd;
        }
        .hidden { display: none; }
        .loading {
            text-align: center;
            padding: 20px;
            color: #6b7280;
        }
        .excel-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background: #f9fafb;
        }
        .excel-upload-area.dragover {
            background: #dbeafe;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <!-- Modal UyarÄ± Penceresi -->
    <div id="resultModalOverlay" class="result-modal-overlay">
        <div id="resultModal" class="result-modal">
            <div id="resultModalIcon" class="result-modal-icon"></div>
            <div id="resultModalTitle" class="result-modal-title"></div>
            <div id="resultModalMessage" class="result-modal-message"></div>
            <button class="result-modal-btn" onclick="closeResultModal()">Tamam</button>
        </div>
    </div>
    
    <div class="header">
        <h1>ğŸ“ˆ LGS Deneme Takip - Admin Paneli</h1>
        <button class="btn-back" onclick="window.location.href='/admin/dashboard'">â† Ana Sayfa</button>
        <div style="clear: both;"></div>
    </div>

    <div class="container">
        <div id="alertBox"></div>

        <div class="card" style="background: linear-gradient(135deg, #fff5f5 0%, #ffe4e6 100%); border: 2px solid #fca5a5;">
            <h2 style="color: #991b1b;">ğŸš€ YENÄ°: Toplu Deneme YÃ¼kleme (TÃ¼m SÄ±nÄ±flar Tek Seferde)</h2>
            <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #ef4444;">
                <p style="margin: 0; color: #374151;"><strong>âœ¨ Ã–zellik:</strong> 5,6,7,8. sÄ±nÄ±f tÃ¼m Ã¶ÄŸrencilerin deneme sonuÃ§larÄ±nÄ± tek Excel ile yÃ¼kleyin!</p>
                <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 0.9em;">â€¢ SÄ±nÄ±f + Ad Soyad ile otomatik eÅŸleÅŸtirme â€¢ Her Ã¶ÄŸrenci iÃ§in max 80 deneme</p>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                <button class="btn btn-warning" onclick="downloadBulkTemplate()" style="flex: 1; min-width: 200px;">ğŸ“¥ Toplu YÃ¼kleme Åablonunu Ä°ndir</button>
                <button class="btn btn-success" onclick="uploadWithMode('new')" style="flex: 1; min-width: 200px;">â• Yeni Deneme Olarak Ekle</button>
                <button class="btn btn-primary" onclick="uploadWithMode('update')" style="flex: 1; min-width: 200px;">ğŸ”„ Son Denemeyi GÃ¼ncelle</button>
            </div>
            <input type="file" id="bulkExcelFile" accept=".xlsx" style="display:none;" onchange="uploadBulkExcel()">
            <div style="background: #dbeafe; padding: 10px; border-radius: 5px; font-size: 0.85em; color: #1e40af;">
                <strong>ğŸ“– NasÄ±l KullanÄ±lÄ±r:</strong><br>
                1. "Toplu YÃ¼kleme Åablonunu Ä°ndir" butonuna tÄ±klayÄ±n<br>
                2. Excel'de tÃ¼m Ã¶ÄŸrencilerin deneme sonuÃ§larÄ±nÄ± doldurun (SÄ±nÄ±f + Ad Soyad)<br>
                3. "Toplu Excel YÃ¼kle" ile sisteme aktarÄ±n
            </div>
            <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 8px; border: 2px solid #86efac;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div style="flex: 1;">
                        <strong style="color: #166534;">ğŸ… Rozet Sistemi</strong>
                        <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #15803d;">Deneme yÃ¼kledikten sonra Ã¶ÄŸrenci rozetlerini gÃ¼ncelleyin</p>
                    </div>
                    <button class="btn" onclick="refreshAllBadges()" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white;">
                        ğŸ… TÃ¼m Rozetleri GÃ¼ncelle
                    </button>
                </div>
            </div>
            <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border-radius: 8px; border: 2px solid #fca5a5;">
                <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                    <div style="flex: 1;">
                        <strong style="color: #dc2626;">ğŸ—‘ï¸ Toplu Deneme Silme</strong>
                        <p style="margin: 5px 0 0 0; font-size: 0.85em; color: #991b1b;">MÃ¼kerrer yÃ¼kleme durumunda belirli sÄ±nÄ±f ve deneme numarasÄ±nÄ± silin</p>
                    </div>
                    <select id="deleteClassSelect" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="">SÄ±nÄ±f seÃ§in</option>
                        <option value="5A">5A</option><option value="5B">5B</option><option value="5C">5C</option><option value="5D">5D</option><option value="5E">5E</option>
                        <option value="6A">6A</option><option value="6B">6B</option><option value="6C">6C</option><option value="6D">6D</option><option value="6E">6E</option>
                        <option value="7A">7A</option><option value="7B">7B</option><option value="7C">7C</option><option value="7D">7D</option><option value="7E">7E</option>
                        <option value="8A">8A</option><option value="8B">8B</option><option value="8C">8C</option><option value="8D">8D</option><option value="8E">8E</option>
                    </select>
                    <input type="number" id="deleteExamNumber" placeholder="Deneme No" min="1" max="80" style="width: 100px; padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                    <button class="btn" onclick="bulkDeleteExam()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
                        ğŸ—‘ï¸ Sil
                    </button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ“¤ Excel ile Tekli Veri GiriÅŸi (ESKÄ° YÃ–N TEM)</h2>
            <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9em;">
                â„¹ï¸ Not: Bu yÃ¶ntem tek Ã¶ÄŸrenci iÃ§in kullanÄ±lÄ±r. Toplu yÃ¼kleme iÃ§in yukarÄ±daki yeni sistemi kullanÄ±n.
            </p>
            <div class="form-grid">
                <button class="btn btn-warning" onclick="downloadTemplate()">ğŸ“¥ Tekli Åablonu Ä°ndir</button>
            </div>
            <div class="excel-upload-area" id="uploadArea">
                <p style="font-size: 1.2em; margin-bottom: 10px;">ğŸ“Š Excel dosyasÄ±nÄ± buraya sÃ¼rÃ¼kleyin veya seÃ§in</p>
                <input type="file" id="excelFile" accept=".xlsx" style="display:none;" onchange="uploadExcel()">
                <button class="btn btn-primary" onclick="document.getElementById('excelFile').click()">Dosya SeÃ§</button>
            </div>
        </div>

        <!-- YENÄ° SÄ°STEM 1: SÄ±nÄ±f Seviyesi KarÅŸÄ±laÅŸtÄ±rma -->
        <div class="card">
            <h2>ğŸ“Š SÄ±nÄ±f Seviyesi KarÅŸÄ±laÅŸtÄ±rma</h2>
            <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9em;">
                â„¹ï¸ AynÄ± seviyedeki sÄ±nÄ±flarÄ± karÅŸÄ±laÅŸtÄ±rÄ±n (Ã¶rn: 7A, 7B, 7C, 7D karÅŸÄ±laÅŸtÄ±rmasÄ±)
            </p>
            <div class="form-grid">
                <div class="form-group">
                    <label>SÄ±nÄ±f Seviyesi</label>
                    <select id="gradeLevelSelect">
                        <option value="">Seviye seÃ§in...</option>
                        <option value="5">5. SÄ±nÄ±flar (A,B,C,D,E)</option>
                        <option value="6">6. SÄ±nÄ±flar (A,B,C,D,E)</option>
                        <option value="7">7. SÄ±nÄ±flar (A,B,C,D,E)</option>
                        <option value="8">8. SÄ±nÄ±flar (A,B,C,D,E)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Deneme No</label>
                    <select id="gradeExamSelect">
                        <option value="">Deneme seÃ§in...</option>
                        <option value="1">Deneme 1</option>
                        <option value="2">Deneme 2</option>
                        <option value="3">Deneme 3</option>
                        <option value="4">Deneme 4</option>
                        <option value="5">Deneme 5</option>
                        <option value="6">Deneme 6</option>
                        <option value="7">Deneme 7</option>
                        <option value="8">Deneme 8</option>
                        <option value="9">Deneme 9</option>
                        <option value="10">Deneme 10</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ders</label>
                    <select id="gradeSubjectSelect">
                        <option value="">Ders seÃ§in...</option>
                        <option value="turkce">TÃ¼rkÃ§e</option>
                        <option value="matematik">Matematik</option>
                        <option value="fen">Fen Bilimleri</option>
                        <option value="sosyal">Sosyal Bilgiler</option>
                        <option value="ingilizce">Ä°ngilizce</option>
                        <option value="din">Din KÃ¼ltÃ¼rÃ¼</option>
                        <option value="lgs_score">LGS PuanÄ±</option>
                    </select>
                </div>
            </div>
            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="showGradeLevelComparison()" style="padding: 12px 40px;">
                    ğŸ“Š SÄ±nÄ±flarÄ± KarÅŸÄ±laÅŸtÄ±r
                </button>
            </div>

            <div id="gradeLevelChartBox" style="display:none; margin-top: 30px;">
                <h3 style="color: #1f2937; margin-bottom: 20px;">
                    <span id="gradeLevelTitle"></span>
                </h3>
                <div class="chart-container" style="height: 450px;">
                    <canvas id="gradeLevelChart"></canvas>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;" id="gradeLevelStats">
                    </div>
                </div>
            </div>
        </div>

        <!-- YENÄ° SÄ°STEM 2: Ã–ÄŸrenci Detay GÃ¶rÃ¼nÃ¼mÃ¼ -->
        <div class="card">
            <h2>ğŸ‘¤ Ã–ÄŸrenci Detay GÃ¶rÃ¼nÃ¼mÃ¼</h2>
            <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9em;">
                â„¹ï¸ Belirli bir Ã¶ÄŸrencinin tÃ¼m deneme grafiklerini gÃ¶rÃ¼ntÃ¼leyin
            </p>
            <div class="form-grid">
                <div class="form-group">
                    <label>SÄ±nÄ±f SeÃ§in</label>
                    <select id="studentDetailClassSelect" onchange="loadStudentsForDetail()">
                        <option value="">SÄ±nÄ±f seÃ§in...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ã–ÄŸrenci SeÃ§in</label>
                    <select id="studentDetailSelect" disabled>
                        <option value="">Ã–nce sÄ±nÄ±f seÃ§in...</option>
                    </select>
                </div>
            </div>
            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="showStudentDetail()" style="padding: 12px 40px;">
                    ğŸ“ˆ Ã–ÄŸrenci Grafiklerini GÃ¶ster
                </button>
            </div>

            <div id="studentDetailBox" style="display:none; margin-top: 30px;">
                <h3 style="color: #1f2937; margin-bottom: 20px;">
                    ğŸ“Š <span id="studentDetailName"></span> - Deneme GeliÅŸim Grafikler i
                </h3>
                
                <div class="card" style="background: #f3f4f6; margin-bottom: 15px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“Š LGS Puan GeliÅŸimi</h3>
                    <div class="chart-container">
                        <canvas id="studentDetailLgsChart"></canvas>
                    </div>
                </div>

                <div class="card" style="background: #f3f4f6; margin-bottom: 15px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“š TÃ¼rkÃ§e Net GeliÅŸimi</h3>
                    <div class="chart-container">
                        <canvas id="studentDetailTurkceChart"></canvas>
                    </div>
                </div>

                <div class="card" style="background: #f3f4f6; margin-bottom: 15px;">
                    <h3 style="margin-bottom: 15px;">ğŸ”¢ Matematik Net GeliÅŸimi</h3>
                    <div class="chart-container">
                        <canvas id="studentDetailMatematikChart"></canvas>
                    </div>
                </div>

                <div class="card" style="background: #f3f4f6; margin-bottom: 15px;">
                    <h3 style="margin-bottom: 15px;">ğŸ§ª Fen Bilimleri Net GeliÅŸimi</h3>
                    <div class="chart-container">
                        <canvas id="studentDetailFenChart"></canvas>
                    </div>
                </div>

                <div class="card" style="background: #f3f4f6; margin-bottom: 15px;">
                    <h3 style="margin-bottom: 15px;">ğŸŒ Sosyal Bilgiler Net GeliÅŸimi</h3>
                    <div class="chart-container">
                        <canvas id="studentDetailSosyalChart"></canvas>
                    </div>
                </div>

                <div class="card" style="background: #f3f4f6; margin-bottom: 15px;">
                    <h3 style="margin-bottom: 15px;">ğŸ‡¬ğŸ‡§ Ä°ngilizce Net GeliÅŸimi</h3>
                    <div class="chart-container">
                        <canvas id="studentDetailIngilizceChart"></canvas>
                    </div>
                </div>

                <div class="card" style="background: #f3f4f6; margin-bottom: 15px;">
                    <h3 style="margin-bottom: 15px;">ğŸ“– Din KÃ¼ltÃ¼rÃ¼ Net GeliÅŸimi</h3>
                    <div class="chart-container">
                        <canvas id="studentDetailDinChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- DENEME SÄ°LME BÃ–LÃœMÃœ -->
        <div class="card">
            <h2>ğŸ—‘ï¸ Deneme SÄ±navÄ± Silme</h2>
            <p style="color: #6b7280; margin-bottom: 15px; font-size: 0.9em;">
                âš ï¸ Belirli bir Ã¶ÄŸrencinin veya sÄ±nÄ±fÄ±n deneme sÄ±navlarÄ±nÄ± silebilirsiniz
            </p>
            <div class="form-grid">
                <div class="form-group">
                    <label>SÄ±nÄ±f SeÃ§in</label>
                    <select id="deleteExamClassSelect" onchange="loadStudentsForDelete()">
                        <option value="">SÄ±nÄ±f seÃ§in...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Ã–ÄŸrenci SeÃ§in</label>
                    <select id="deleteExamStudentSelect" onchange="loadExamsForDelete()" disabled>
                        <option value="">Ã–nce sÄ±nÄ±f seÃ§in...</option>
                    </select>
                </div>
            </div>
            <div style="text-align: center;">
                <button class="btn btn-primary" onclick="loadExamsForDelete()" style="padding: 12px 40px;">
                    ğŸ“‹ Denemeleri Listele
                </button>
            </div>

            <div id="deleteExamBox" style="display:none; margin-top: 30px;">
                <h3 style="color: #1f2937; margin-bottom: 20px;">
                    ğŸ“‹ <span id="deleteExamStudentName"></span> - Deneme Listesi
                </h3>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #667eea, #764ba2); color: white;">
                                <th style="padding: 12px; text-align: center;">Deneme No</th>
                                <th style="padding: 12px; text-align: center;">TÃ¼rkÃ§e</th>
                                <th style="padding: 12px; text-align: center;">Matematik</th>
                                <th style="padding: 12px; text-align: center;">Fen</th>
                                <th style="padding: 12px; text-align: center;">Sosyal</th>
                                <th style="padding: 12px; text-align: center;">Ä°ngilizce</th>
                                <th style="padding: 12px; text-align: center;">Din</th>
                                <th style="padding: 12px; text-align: center;">LGS PuanÄ±</th>
                                <th style="padding: 12px; text-align: center;">Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody id="deleteExamTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>ğŸ« SÄ±nÄ±f BazÄ±nda Analiz</h2>
            <div class="form-group">
                <label>SÄ±nÄ±f SeÃ§in</label>
                <select id="classSelect" onchange="loadClassData()">
                    <option value="">SÄ±nÄ±f seÃ§in...</option>
                </select>
            </div>

            <div id="classChartsBox" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0;">
                    <h3 style="color: #1f2937; margin: 0;">ğŸ“Š <span id="classNameDisplay"></span> SÄ±nÄ±f OrtalamalarÄ±</h3>
                    <button class="btn btn-warning" onclick="downloadClassPDF()" style="display: flex; align-items: center; gap: 8px;">
                        ğŸ“„ PDF Rapor Ä°ndir
                    </button>
                </div>
                
                <div class="chart-container">
                    <canvas id="classSubjectChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <canvas id="classLgsChart"></canvas>
                </div>

                <h3 style="margin: 20px 0; color: #1f2937;">ğŸ‘¥ Ã–ÄŸrenci SeÃ§</h3>
                <div class="form-group">
                    <label>Bireysel Ã–ÄŸrenci GrafiÄŸi Ä°Ã§in SeÃ§im YapÄ±n</label>
                    <select id="studentSelect" onchange="loadStudentDataFromDropdown()">
                        <option value="">Ã–ÄŸrenci seÃ§in...</option>
                    </select>
                </div>

                <details style="margin-top: 20px;">
                    <summary style="cursor: pointer; padding: 10px; background: #f3f4f6; border-radius: 5px; font-weight: 500;">
                        ğŸ“‹ SÄ±nÄ±ftaki TÃ¼m Ã–ÄŸrenciler (Kart GÃ¶rÃ¼nÃ¼mÃ¼)
                    </summary>
                    <div id="studentsList" class="student-grid" style="margin-top: 15px;"></div>
                </details>
            </div>
        </div>

        <div class="card" id="studentChartsBox" style="display:none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0;">ğŸ“Š <span id="studentNameDisplay"></span> - Deneme SonuÃ§larÄ±</h2>
                <button class="btn btn-warning" onclick="downloadStudentPDF()" style="display: flex; align-items: center; gap: 8px;">
                    ğŸ“„ PDF Rapor Ä°ndir
                </button>
            </div>
            
            <div class="chart-container">
                <canvas id="studentSubjectChart"></canvas>
            </div>
            
            <div class="chart-container">
                <canvas id="studentLgsChart"></canvas>
            </div>

            <h3 style="margin: 20px 0;">ğŸ“‹ TÃ¼m Denemeler</h3>
            <div style="overflow-x: auto;">
                <table id="studentExamsTable">
                    <thead>
                        <tr>
                            <th>Deneme</th>
                            <th>TÃ¼rkÃ§e</th>
                            <th>Mat</th>
                            <th>Fen</th>
                            <th>Sosyal</th>
                            <th>Ä°ng</th>
                            <th>Din</th>
                            <th>LGS</th>
                            <th>Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody id="studentExamsBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let classSubjectChart = null;
        let classLgsChart = null;
        let studentSubjectChart = null;
        let studentLgsChart = null;
        let selectedStudentId = null;

        const classes = ['5A', '5B', '5C', '5D', '5E', '6A', '6B', '6C', '6D', '6E', '7A', '7B', '7C', '7D', '7E', '8A', '8B', '8C', '8D', '8E'];

        async function checkAuth() {
            try {
                const response = await fetch('/api/current-user');
                const data = await response.json();
                if (!data.authenticated || data.user.role !== 'admin') {
                    window.location.href = '/ameo_admin_giris';
                    return false;
                }
                return true;
            } catch (error) {
                window.location.href = '/ameo_admin_giris';
                return false;
            }
        }

        function populateClasses() {
            console.log('ğŸ”§ populateClasses Ã§aÄŸrÄ±ldÄ±');
            const select = document.getElementById('classSelect');
            const studentDetailSelect = document.getElementById('studentDetailClassSelect');
            const deleteExamClassSelect = document.getElementById('deleteExamClassSelect');
            
            if (!select) {
                console.error('âŒ classSelect elementi bulunamadÄ±!');
                return;
            }
            if (!studentDetailSelect) {
                console.error('âŒ studentDetailClassSelect elementi bulunamadÄ±!');
                return;
            }
            
            console.log(`âœ… ${classes.length} sÄ±nÄ±f doldurulacak`);
            classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                select.appendChild(option);
                
                // Ã–ÄŸrenci detay dropdown iÃ§in de ekle
                const detailOption = document.createElement('option');
                detailOption.value = className;
                detailOption.textContent = className;
                studentDetailSelect.appendChild(detailOption);
                
                // Silme dropdown iÃ§in de ekle
                if (deleteExamClassSelect) {
                    const deleteOption = document.createElement('option');
                    deleteOption.value = className;
                    deleteOption.textContent = className;
                    deleteExamClassSelect.appendChild(deleteOption);
                }
            });
            console.log('âœ… SÄ±nÄ±f dropdown\'larÄ± dolduruldu');
        }

        async function loadClassData() {
            const className = document.getElementById('classSelect').value;
            if (!className) {
                document.getElementById('classChartsBox').style.display = 'none';
                document.getElementById('studentChartsBox').style.display = 'none';
                currentClassName = '';
                return;
            }
            
            currentClassName = className;
            
            try {
                // SÄ±nÄ±f ortalamasÄ±
                const avgResponse = await fetch(`/admin/api/practice-exams/class-average/${className}`);
                const avgData = await avgResponse.json();
                
                // SÄ±nÄ±ftaki Ã¶ÄŸrenciler
                const studentsResponse = await fetch(`/admin/api/practice-exams/class-students/${className}`);
                const studentsData = await studentsResponse.json();
                
                if (avgData.exams && avgData.exams.length > 0) {
                    document.getElementById('classChartsBox').style.display = 'block';
                    document.getElementById('classNameDisplay').textContent = className;
                    createClassCharts(avgData.exams);
                } else {
                    document.getElementById('classChartsBox').style.display = 'none';
                    showAlert(`${className} sÄ±nÄ±fÄ± iÃ§in henÃ¼z deneme verisi girilmemiÅŸ`, 'info');
                }
                
                if (studentsData.students && studentsData.students.length > 0) {
                    displayStudentsList(studentsData.students);
                } else {
                    document.getElementById('studentsList').innerHTML = '<p style="color: #6b7280;">Bu sÄ±nÄ±fta Ã¶ÄŸrenci bulunmuyor</p>';
                }
                
            } catch (error) {
                showAlert('Veri yÃ¼klenemedi: ' + error.message, 'error');
            }
        }

        function displayStudentsList(students) {
            // Dropdown'u doldur
            const dropdown = document.getElementById('studentSelect');
            dropdown.innerHTML = '<option value="">Ã–ÄŸrenci seÃ§in...</option>';
            
            students.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = student.full_name;
                option.dataset.name = student.full_name;
                dropdown.appendChild(option);
            });
            
            // KartlarÄ± doldur
            const container = document.getElementById('studentsList');
            container.innerHTML = '';
            
            students.forEach(student => {
                const card = document.createElement('div');
                card.className = 'student-card';
                card.onclick = (evt) => loadStudentData(student.id, student.full_name, evt);
                card.innerHTML = `
                    <div class="name">${student.full_name}</div>
                    <div class="info">ID: ${student.id}</div>
                `;
                container.appendChild(card);
            });
        }

        function loadStudentDataFromDropdown() {
            const dropdown = document.getElementById('studentSelect');
            const studentId = dropdown.value;
            const studentName = dropdown.options[dropdown.selectedIndex].dataset.name;
            
            if (!studentId) {
                document.getElementById('studentChartsBox').style.display = 'none';
                return;
            }
            
            loadStudentData(studentId, studentName);
        }

        async function loadStudentData(studentId, studentName, evt = null) {
            selectedStudentId = studentId;
            currentStudentId = studentId;
            
            // SeÃ§imi gÃ¶ster (sadece kart tÄ±klamasÄ±nda)
            document.querySelectorAll('.student-card').forEach(card => {
                card.classList.remove('selected');
            });
            if (evt && evt.target) {
                const card = evt.target.closest('.student-card');
                if (card) card.classList.add('selected');
            }
            
            try {
                const response = await fetch(`/teacher/api/practice-exams/student/${studentId}`);
                const data = await response.json();
                
                if (data.exams && data.exams.length > 0) {
                    document.getElementById('studentChartsBox').style.display = 'block';
                    document.getElementById('studentNameDisplay').textContent = studentName;
                    createStudentCharts(data.exams);
                    populateExamsTable(data.exams);
                } else {
                    document.getElementById('studentChartsBox').style.display = 'none';
                    showAlert('Bu Ã¶ÄŸrenci iÃ§in henÃ¼z deneme verisi yok', 'info');
                }
            } catch (error) {
                showAlert('Ã–ÄŸrenci verileri yÃ¼klenemedi: ' + error.message, 'error');
            }
        }

        function createClassCharts(exams) {
            const examNumbers = exams.map(e => 'Deneme ' + e.exam_number);
            
            const turkceNets = exams.map(e => parseFloat(e.turkce_net));
            const matematikNets = exams.map(e => parseFloat(e.matematik_net));
            const fenNets = exams.map(e => parseFloat(e.fen_net));
            const sosyalNets = exams.map(e => parseFloat(e.sosyal_net));
            const ingilizceNets = exams.map(e => parseFloat(e.ingilizce_net));
            const dinNets = exams.map(e => parseFloat(e.din_net));
            const lgsScores = exams.map(e => parseFloat(e.lgs_score));
            
            if (classSubjectChart) classSubjectChart.destroy();
            if (classLgsChart) classLgsChart.destroy();
            
            const firstScore = lgsScores[0];
            const lastScore = lgsScores[lgsScores.length - 1];
            const progress = lastScore - firstScore;
            const progressPercent = ((progress / firstScore) * 100).toFixed(1);
            const progressText = progress >= 0 ? `+${progress.toFixed(1)} puan (â†— %${progressPercent})` : `${progress.toFixed(1)} puan (â†˜ %${progressPercent})`;
            
            const lgsCtx = document.getElementById('classLgsChart').getContext('2d');
            classLgsChart = new Chart(lgsCtx, {
                type: 'bar',
                data: {
                    labels: examNumbers,
                    datasets: [{
                        label: 'SÄ±nÄ±f Ortalama LGS PuanÄ±',
                        data: lgsScores,
                        backgroundColor: '#667eea',
                        borderColor: '#4c51bf',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 1500, easing: 'easeInOutQuart' },
                    plugins: {
                        title: { 
                            display: true, 
                            text: `SÄ±nÄ±f Ortalama LGS Puan GeliÅŸimi: ${progressText}`,
                            font: { size: 18, weight: 'bold' },
                            color: progress >= 0 ? '#667eea' : '#ef4444'
                        },
                        legend: { display: false },
                        datalabels: {
                            align: 'top',
                            anchor: 'end',
                            color: '#667eea',
                            font: { size: 11, weight: 'bold' },
                            formatter: (value) => value.toFixed(0)
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true, 
                            max: 500,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            ticks: { font: { size: 12 } }
                        },
                        x: { grid: { color: 'rgba(0, 0, 0, 0.05)' } }
                    }
                }
            });
            
            const subjectCtx = document.getElementById('classSubjectChart').getContext('2d');
            classSubjectChart = new Chart(subjectCtx, {
                type: 'bar',
                data: {
                    labels: examNumbers,
                    datasets: [
                        { label: 'TÃ¼rkÃ§e', data: turkceNets, backgroundColor: '#ef4444', borderColor: '#dc2626', borderWidth: 2, borderRadius: 6 },
                        { label: 'Matematik', data: matematikNets, backgroundColor: '#3b82f6', borderColor: '#2563eb', borderWidth: 2, borderRadius: 6 },
                        { label: 'Fen', data: fenNets, backgroundColor: '#10b981', borderColor: '#059669', borderWidth: 2, borderRadius: 6 },
                        { label: 'Sosyal', data: sosyalNets, backgroundColor: '#f59e0b', borderColor: '#d97706', borderWidth: 2, borderRadius: 6 },
                        { label: 'Ä°ngilizce', data: ingilizceNets, backgroundColor: '#8b5cf6', borderColor: '#7c3aed', borderWidth: 2, borderRadius: 6 },
                        { label: 'Din', data: dinNets, backgroundColor: '#ec4899', borderColor: '#db2777', borderWidth: 2, borderRadius: 6 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 1500, easing: 'easeInOutQuart' },
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: { display: true, text: 'SÄ±nÄ±f Ortalama Net GeliÅŸimi (Ders BazÄ±nda)', font: { size: 18, weight: 'bold' } },
                        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true } },
                        datalabels: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 20, grid: { color: 'rgba(0, 0, 0, 0.1)' }, ticks: { stepSize: 5 } },
                        x: { grid: { color: 'rgba(0, 0, 0, 0.05)' } }
                    }
                }
            });
        }

        function createStudentCharts(exams) {
            const examNumbers = exams.map(e => 'D' + e.exam_number);
            
            const turkceNets = exams.map(e => parseFloat(e.turkce_net));
            const matematikNets = exams.map(e => parseFloat(e.matematik_net));
            const fenNets = exams.map(e => parseFloat(e.fen_net));
            const sosyalNets = exams.map(e => parseFloat(e.sosyal_net));
            const ingilizceNets = exams.map(e => parseFloat(e.ingilizce_net));
            const dinNets = exams.map(e => parseFloat(e.din_net));
            const lgsScores = exams.map(e => parseFloat(e.lgs_score));
            
            if (studentSubjectChart) studentSubjectChart.destroy();
            if (studentLgsChart) studentLgsChart.destroy();
            
            const firstScore = lgsScores[0];
            const lastScore = lgsScores[lgsScores.length - 1];
            const progress = lastScore - firstScore;
            const progressPercent = ((progress / firstScore) * 100).toFixed(1);
            const progressText = progress >= 0 ? `+${progress.toFixed(1)} puan (â†— %${progressPercent})` : `${progress.toFixed(1)} puan (â†˜ %${progressPercent})`;
            
            const lgsCtx = document.getElementById('studentLgsChart').getContext('2d');
            studentLgsChart = new Chart(lgsCtx, {
                type: 'bar',
                data: {
                    labels: examNumbers,
                    datasets: [{
                        label: 'LGS PuanÄ±',
                        data: lgsScores,
                        backgroundColor: '#059669',
                        borderColor: '#047857',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 1500, easing: 'easeInOutQuart' },
                    plugins: {
                        title: { 
                            display: true, 
                            text: `LGS Puan GeliÅŸimi: ${progressText}`,
                            font: { size: 18, weight: 'bold' },
                            color: progress >= 0 ? '#059669' : '#ef4444'
                        },
                        legend: { display: false },
                        datalabels: {
                            align: 'top',
                            anchor: 'end',
                            color: '#059669',
                            font: { size: 11, weight: 'bold' },
                            formatter: (value) => value.toFixed(0)
                        }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            max: 500,
                            grid: { color: 'rgba(0, 0, 0, 0.1)' },
                            ticks: { font: { size: 12 } }
                        },
                        x: { grid: { color: 'rgba(0, 0, 0, 0.05)' } }
                    }
                }
            });
            
            const subjectCtx = document.getElementById('studentSubjectChart').getContext('2d');
            studentSubjectChart = new Chart(subjectCtx, {
                type: 'bar',
                data: {
                    labels: examNumbers,
                    datasets: [
                        { label: 'TÃ¼rkÃ§e', data: turkceNets, backgroundColor: '#ef4444', borderColor: '#dc2626', borderWidth: 2, borderRadius: 6 },
                        { label: 'Matematik', data: matematikNets, backgroundColor: '#3b82f6', borderColor: '#2563eb', borderWidth: 2, borderRadius: 6 },
                        { label: 'Fen', data: fenNets, backgroundColor: '#10b981', borderColor: '#059669', borderWidth: 2, borderRadius: 6 },
                        { label: 'Sosyal', data: sosyalNets, backgroundColor: '#f59e0b', borderColor: '#d97706', borderWidth: 2, borderRadius: 6 },
                        { label: 'Ä°ngilizce', data: ingilizceNets, backgroundColor: '#8b5cf6', borderColor: '#7c3aed', borderWidth: 2, borderRadius: 6 },
                        { label: 'Din', data: dinNets, backgroundColor: '#ec4899', borderColor: '#db2777', borderWidth: 2, borderRadius: 6 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 1500, easing: 'easeInOutQuart' },
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        title: { display: true, text: 'Ders BazÄ±nda Net GeliÅŸimi', font: { size: 18, weight: 'bold' } },
                        legend: { position: 'bottom', labels: { padding: 15, usePointStyle: true } },
                        datalabels: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, max: 20, grid: { color: 'rgba(0, 0, 0, 0.1)' }, ticks: { stepSize: 5 } },
                        x: { grid: { color: 'rgba(0, 0, 0, 0.05)' } }
                    }
                }
            });
        }

        async function refreshAllBadges() {
            if (!confirm('TÃ¼m Ã¶ÄŸrencilerin rozetleri yeniden hesaplanacak. Devam etmek istiyor musunuz?')) {
                return;
            }
            
            try {
                showAlert('ğŸ… Rozetler hesaplanÄ±yor... LÃ¼tfen bekleyin.', 'info');
                
                const response = await fetch('/api/admin/refresh-all-badges', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin'
                });
                
                if (!response.ok) {
                    const text = await response.text();
                    try {
                        const errorData = JSON.parse(text);
                        showAlert('âŒ ' + (errorData.error || 'Bilinmeyen hata'), 'error');
                    } catch {
                        showAlert('âŒ Sunucu hatasÄ±: ' + response.status, 'error');
                    }
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    let msg = `âœ… ${result.message}`;
                    if (result.warnings && result.warnings.length > 0) {
                        msg += '\nâš ï¸ BazÄ± uyarÄ±lar var.';
                    }
                    showAlert(msg, 'success');
                } else {
                    showAlert('âŒ ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('âŒ Rozet gÃ¼ncelleme hatasÄ±: ' + error.message, 'error');
            }
        }

        function downloadTemplate() {
            window.open('/teacher/practice-exams/download-template', '_blank');
        }

        function downloadBulkTemplate() {
            window.open('/admin/practice-exams/download-bulk-template', '_blank');
        }

        async function bulkDeleteExam() {
            const className = document.getElementById('deleteClassSelect').value;
            const examNumber = document.getElementById('deleteExamNumber').value;
            
            if (!className || !examNumber) {
                showAlert('âŒ LÃ¼tfen sÄ±nÄ±f ve deneme numarasÄ± seÃ§in', 'error');
                return;
            }
            
            if (!confirm(`âš ï¸ DÄ°KKAT: ${className} sÄ±nÄ±fÄ±nÄ±n ${examNumber}. denemesi silinecek!\n\nBu iÅŸlem geri alÄ±namaz. Devam etmek istiyor musunuz?`)) {
                return;
            }
            
            try {
                const response = await fetch('/admin/practice-exams/delete-bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ class_name: className, exam_number: examNumber })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showResultModal('Silme BaÅŸarÄ±lÄ±', result.message, 'success');
                    document.getElementById('deleteClassSelect').value = '';
                    document.getElementById('deleteExamNumber').value = '';
                    if (document.getElementById('classSelect').value) {
                        loadClassData();
                    }
                } else {
                    showResultModal('Silme HatasÄ±', result.error, 'error');
                }
            } catch (error) {
                showResultModal('BaÄŸlantÄ± HatasÄ±', 'Silme hatasÄ±: ' + error.message, 'error');
            }
        }

        let currentUploadMode = 'new';
        
        function uploadWithMode(mode) {
            currentUploadMode = mode;
            document.getElementById('bulkExcelFile').click();
        }

        async function uploadBulkExcel() {
            const fileInput = document.getElementById('bulkExcelFile');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('update_mode', currentUploadMode);
            
            const modeText = currentUploadMode === 'update' ? 'ğŸ”„ GÃ¼ncelleme' : 'â• Yeni ekleme';
            
            try {
                showAlert(`ğŸ“¤ ${modeText} modu ile toplu Excel dosyasÄ± yÃ¼kleniyor... LÃ¼tfen bekleyin.`, 'info');
                
                const response = await fetch('/admin/practice-exams/upload-bulk', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    let message = result.message;
                    if (result.inserted > 0 || result.updated > 0) {
                        message += `\n\nğŸ“Š Ã–zet:\nâœ… ${result.inserted} yeni kayÄ±t eklendi\nğŸ”„ ${result.updated} kayÄ±t gÃ¼ncellendi`;
                    }
                    if (result.skipped > 0) {
                        message += `\nâ­ï¸ ${result.skipped} kayÄ±t atlandÄ± (80 deneme sÄ±nÄ±rÄ±)`;
                    }
                    if (result.not_found_students && result.not_found_students.length > 0) {
                        message += `\n\nâŒ Bulunamayan Ã–ÄŸrenciler (${result.not_found_students.length}):\n`;
                        result.not_found_students.slice(0, 15).forEach(s => {
                            message += `â€¢ ${s.class_name} - ${s.name}\n`;
                        });
                        if (result.not_found_students.length > 15) {
                            message += `... ve ${result.not_found_students.length - 15} Ã¶ÄŸrenci daha`;
                        }
                    }
                    showResultModal('Toplu YÃ¼kleme TamamlandÄ±', message, 'success');
                    fileInput.value = '';
                    
                    if (document.getElementById('classSelect').value) {
                        loadClassData();
                    }
                } else {
                    showResultModal('YÃ¼kleme HatasÄ±', result.error, 'error');
                }
            } catch (error) {
                showResultModal('BaÄŸlantÄ± HatasÄ±', 'Toplu yÃ¼kleme hatasÄ±: ' + error.message, 'error');
            }
        }

        async function uploadExcel() {
            const fileInput = document.getElementById('excelFile');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const formData = new FormData();
            formData.append('file', file);
            
            try {
                showAlert('ğŸ“¤ Excel dosyasÄ± yÃ¼kleniyor...', 'info');
                
                const response = await fetch('/teacher/practice-exams/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(result.message, 'success');
                    fileInput.value = '';
                    // EÄŸer sÄ±nÄ±f seÃ§iliyse yenile
                    if (document.getElementById('classSelect').value) {
                        loadClassData();
                    }
                } else {
                    showAlert('âŒ ' + result.error, 'error');
                }
            } catch (error) {
                showAlert('YÃ¼kleme hatasÄ±: ' + error.message, 'error');
            }
        }

        function showAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            alertBox.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => { alertBox.innerHTML = ''; }, 5000);
        }

        function showResultModal(title, message, type) {
            const overlay = document.getElementById('resultModalOverlay');
            const modal = document.getElementById('resultModal');
            const icon = document.getElementById('resultModalIcon');
            const titleEl = document.getElementById('resultModalTitle');
            const messageEl = document.getElementById('resultModalMessage');
            
            modal.className = 'result-modal ' + type;
            
            if (type === 'success') {
                icon.textContent = 'âœ…';
            } else if (type === 'error') {
                icon.textContent = 'âŒ';
            } else {
                icon.textContent = 'â„¹ï¸';
            }
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            overlay.style.display = 'flex';
        }
        
        function closeResultModal() {
            document.getElementById('resultModalOverlay').style.display = 'none';
        }

        document.getElementById('uploadArea').addEventListener('dragover', (e) => {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        });

        document.getElementById('uploadArea').addEventListener('dragleave', (e) => {
            e.currentTarget.classList.remove('dragover');
        });

        document.getElementById('uploadArea').addEventListener('drop', (e) => {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            document.getElementById('excelFile').files = e.dataTransfer.files;
            uploadExcel();
        });

        // Deneme Tablosu
        function populateExamsTable(exams) {
            const tbody = document.getElementById('studentExamsBody');
            tbody.innerHTML = '';
            
            exams.forEach(exam => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${exam.exam_number}</td>
                    <td>${parseFloat(exam.turkce_net).toFixed(1)}</td>
                    <td>${parseFloat(exam.matematik_net).toFixed(1)}</td>
                    <td>${parseFloat(exam.fen_net).toFixed(1)}</td>
                    <td>${parseFloat(exam.sosyal_net).toFixed(1)}</td>
                    <td>${parseFloat(exam.ingilizce_net).toFixed(1)}</td>
                    <td>${parseFloat(exam.din_net).toFixed(1)}</td>
                    <td><strong>${parseFloat(exam.lgs_score).toFixed(2)}</strong></td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteExam(${exam.id}, ${exam.exam_number})" 
                                style="padding: 5px 10px; font-size: 0.9em;">
                            ğŸ—‘ï¸ Sil
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function deleteExam(examId, examNumber) {
            if (!confirm(`${examNumber} numaralÄ± denemeyi silmek istediÄŸinize emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz!`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/practice-exams/delete/${examId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showAlert(`Deneme ${examNumber} baÅŸarÄ±yla silindi!`, 'success');
                    
                    // Grafikleri ve tabloyu yeniden yÃ¼kle
                    if (currentStudentId) {
                        const studentName = document.getElementById('studentNameDisplay').textContent;
                        const refreshResponse = await fetch(`/teacher/api/practice-exams/student/${currentStudentId}`);
                        const refreshData = await refreshResponse.json();
                        
                        if (refreshData.exams && refreshData.exams.length > 0) {
                            createStudentCharts(refreshData.exams);
                            populateExamsTable(refreshData.exams);
                        } else {
                            document.getElementById('studentChartsBox').style.display = 'none';
                            showAlert('Bu Ã¶ÄŸrencinin artÄ±k deneme verisi yok', 'info');
                        }
                    }
                    
                    // SÄ±nÄ±f ortalamasÄ±nÄ± da gÃ¼ncelle
                    if (currentClassName) {
                        loadClassData();
                    }
                } else {
                    showAlert('Silme iÅŸlemi baÅŸarÄ±sÄ±z: ' + data.error, 'error');
                }
            } catch (error) {
                showAlert('Silme hatasÄ±: ' + error.message, 'error');
            }
        }

        // DetaylÄ± Analiz FonksiyonlarÄ±
        let analysisChart = null;

        async function loadExamsForAnalysis() {
            const className = document.getElementById('analysisClassSelect').value;
            const examSelect = document.getElementById('analysisExamSelect');
            const subjectSelect = document.getElementById('analysisSubjectSelect');
            
            if (!className) {
                examSelect.disabled = true;
                subjectSelect.disabled = true;
                examSelect.innerHTML = '<option value="">Ã–nce sÄ±nÄ±f seÃ§in...</option>';
                document.getElementById('analysisChartBox').style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/practice-exams/class/${className}`);
                const data = await response.json();
                
                examSelect.innerHTML = '<option value="">Deneme seÃ§in...</option>';
                
                if (data.exams && data.exams.length > 0) {
                    // Deneme numaralarÄ±nÄ± benzersiz hale getir
                    const uniqueExams = [...new Set(data.exams.map(e => e.exam_number))];
                    uniqueExams.sort((a, b) => a - b);
                    
                    uniqueExams.forEach(examNum => {
                        const option = document.createElement('option');
                        option.value = examNum;
                        option.textContent = `Deneme ${examNum}`;
                        examSelect.appendChild(option);
                    });
                    
                    examSelect.disabled = false;
                    subjectSelect.disabled = false;
                } else {
                    examSelect.innerHTML = '<option value="">Bu sÄ±nÄ±fta deneme yok</option>';
                }
            } catch (error) {
                console.error('Deneme yÃ¼kleme hatasÄ±:', error);
                showAlert('Denemeler yÃ¼klenemedi: ' + error.message, 'error');
            }
        }

        async function showAnalysisChart() {
            const className = document.getElementById('analysisClassSelect').value;
            const examNumber = document.getElementById('analysisExamSelect').value;
            const subject = document.getElementById('analysisSubjectSelect').value;
            
            if (!className || !examNumber || !subject) {
                alert('LÃ¼tfen sÄ±nÄ±f, deneme ve ders seÃ§in!');
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/practice-exams/class/${className}`);
                const data = await response.json();
                
                // SeÃ§ilen deneme iÃ§in verileri filtrele
                const examData = data.exams.filter(e => e.exam_number == examNumber);
                
                if (examData.length === 0) {
                    alert('Bu deneme iÃ§in veri bulunamadÄ±!');
                    return;
                }
                
                // Ders adÄ± mapping
                const subjectNames = {
                    'turkce': 'TÃ¼rkÃ§e',
                    'matematik': 'Matematik',
                    'fen': 'Fen Bilimleri',
                    'sosyal': 'Sosyal Bilgiler',
                    'ingilizce': 'Ä°ngilizce',
                    'din': 'Din KÃ¼ltÃ¼rÃ¼'
                };
                
                const subjectColors = {
                    'turkce': '#ef4444',
                    'matematik': '#3b82f6',
                    'fen': '#10b981',
                    'sosyal': '#f59e0b',
                    'ingilizce': '#8b5cf6',
                    'din': '#ec4899'
                };
                
                const subjectNetField = subject + '_net';
                
                // Ã–ÄŸrencileri net deÄŸerine gÃ¶re sÄ±rala
                const sortedData = examData.sort((a, b) => parseFloat(b[subjectNetField]) - parseFloat(a[subjectNetField]));
                
                const studentNames = sortedData.map(e => e.full_name);
                const nets = sortedData.map(e => parseFloat(e[subjectNetField]));
                
                // Ä°statistikler
                const avg = (nets.reduce((a, b) => a + b, 0) / nets.length).toFixed(2);
                const max = Math.max(...nets).toFixed(2);
                const min = Math.min(...nets).toFixed(2);
                
                document.getElementById('analysisTitle').textContent = 
                    `${className} - Deneme ${examNumber} - ${subjectNames[subject]}`;
                document.getElementById('analysisAvg').textContent = avg + ' net';
                document.getElementById('analysisMax').textContent = max + ' net';
                document.getElementById('analysisMin').textContent = min + ' net';
                document.getElementById('analysisCount').textContent = nets.length + ' Ã¶ÄŸrenci';
                
                // Grafik oluÅŸtur
                if (analysisChart) analysisChart.destroy();
                
                const ctx = document.getElementById('analysisChart').getContext('2d');
                analysisChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: studentNames,
                        datasets: [{
                            label: subjectNames[subject] + ' Net',
                            data: nets,
                            backgroundColor: subjectColors[subject] + '99',
                            borderColor: subjectColors[subject],
                            borderWidth: 2,
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${className} - Deneme ${examNumber} - ${subjectNames[subject]} SonuÃ§larÄ±`,
                                font: { size: 18, weight: 'bold' },
                                color: '#374151'
                            },
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                callbacks: {
                                    label: function(context) {
                                        return `Net: ${context.parsed.y.toFixed(2)}`;
                                    }
                                }
                            },
                            datalabels: {
                                align: 'top',
                                anchor: 'end',
                                color: '#374151',
                                font: { size: 10, weight: 'bold' },
                                formatter: function(value) {
                                    return value.toFixed(1);
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 20,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    font: { size: 12 },
                                    callback: function(value) {
                                        return value + ' net';
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    font: { size: 10 },
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
                
                document.getElementById('analysisChartBox').style.display = 'block';
                
            } catch (error) {
                console.error('Analiz hatasÄ±:', error);
                showAlert('Grafik oluÅŸturulamadÄ±: ' + error.message, 'error');
            }
        }

        // YENÄ° SÄ°STEM 1: SÄ±nÄ±f Seviyesi KarÅŸÄ±laÅŸtÄ±rma
        let gradeLevelChart = null;
        
        async function showGradeLevelComparison() {
            const gradeLevel = document.getElementById('gradeLevelSelect').value;
            const examNumber = document.getElementById('gradeExamSelect').value;
            const subject = document.getElementById('gradeSubjectSelect').value;
            
            if (!gradeLevel || !examNumber || !subject) {
                alert('LÃ¼tfen sÄ±nÄ±f seviyesi, deneme ve ders seÃ§in!');
                return;
            }
            
            try {
                // Seviyedeki tÃ¼m sÄ±nÄ±flarÄ± al (Ã¶rn: 7A, 7B, 7C, 7D, 7E)
                const gradeClasses = classes.filter(c => c.startsWith(gradeLevel));
                
                // Her sÄ±nÄ±f iÃ§in ortalama hesapla
                const classData = [];
                
                for (const className of gradeClasses) {
                    const response = await fetch(`/admin/api/practice-exams/class/${className}`);
                    const data = await response.json();
                    
                    const examData = data.exams.filter(e => e.exam_number == examNumber);
                    
                    if (examData.length > 0) {
                        let avg;
                        if (subject === 'lgs_score') {
                            const scores = examData.map(e => parseFloat(e.lgs_score));
                            avg = scores.reduce((a, b) => a + b, 0) / scores.length;
                        } else {
                            const nets = examData.map(e => parseFloat(e[subject + '_net']));
                            avg = nets.reduce((a, b) => a + b, 0) / nets.length;
                        }
                        classData.push({ className, avg, count: examData.length });
                    }
                }
                
                if (classData.length === 0) {
                    alert('Bu deneme iÃ§in veri bulunamadÄ±!');
                    return;
                }
                
                const subjectNames = {
                    'turkce': 'TÃ¼rkÃ§e',
                    'matematik': 'Matematik',
                    'fen': 'Fen Bilimleri',
                    'sosyal': 'Sosyal Bilgiler',
                    'ingilizce': 'Ä°ngilizce',
                    'din': 'Din KÃ¼ltÃ¼rÃ¼',
                    'lgs_score': 'LGS PuanÄ±'
                };
                
                const subjectColors = {
                    'turkce': '#ef4444',
                    'matematik': '#3b82f6',
                    'fen': '#10b981',
                    'sosyal': '#f59e0b',
                    'ingilizce': '#8b5cf6',
                    'din': '#ec4899',
                    'lgs_score': '#10b981'
                };
                
                const labels = classData.map(d => d.className);
                const values = classData.map(d => d.avg);
                
                document.getElementById('gradeLevelTitle').textContent = 
                    `${gradeLevel}. SÄ±nÄ±flar - Deneme ${examNumber} - ${subjectNames[subject]} KarÅŸÄ±laÅŸtÄ±rmasÄ±`;
                
                // Ä°statistikleri gÃ¶ster
                const statsHTML = classData.map(d => `
                    <div>
                        <strong>${d.className}:</strong>
                        <div style="font-size: 1.5em; color: ${subjectColors[subject]}; font-weight: bold;">
                            ${d.avg.toFixed(2)} ${subject === 'lgs_score' ? 'puan' : 'net'}
                        </div>
                        <div style="font-size: 0.9em; color: #6b7280;">${d.count} Ã¶ÄŸrenci</div>
                    </div>
                `).join('');
                document.getElementById('gradeLevelStats').innerHTML = statsHTML;
                
                // Grafik oluÅŸtur
                if (gradeLevelChart) gradeLevelChart.destroy();
                
                const ctx = document.getElementById('gradeLevelChart').getContext('2d');
                gradeLevelChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: subjectNames[subject],
                            data: values,
                            backgroundColor: subjectColors[subject] + 'CC',
                            borderColor: subjectColors[subject],
                            borderWidth: 2,
                            borderRadius: 8,
                            barThickness: 80
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        animation: {
                            duration: 1500,
                            easing: 'easeInOutQuart'
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `${gradeLevel}. SÄ±nÄ±flar - ${subjectNames[subject]} KarÅŸÄ±laÅŸtÄ±rma`,
                                font: { size: 20, weight: 'bold' },
                                color: '#374151'
                            },
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 12,
                                titleFont: { size: 14, weight: 'bold' },
                                bodyFont: { size: 13 },
                                callbacks: {
                                    label: function(context) {
                                        const suffix = subject === 'lgs_score' ? ' puan' : ' net';
                                        return `Ortalama: ${context.parsed.y.toFixed(2)}${suffix}`;
                                    }
                                }
                            },
                            datalabels: {
                                display: true,
                                align: 'end',
                                anchor: 'end',
                                offset: 4,
                                color: '#ffffff',
                                backgroundColor: subjectColors[subject],
                                borderRadius: 4,
                                padding: {
                                    top: 6,
                                    bottom: 6,
                                    left: 10,
                                    right: 10
                                },
                                font: { 
                                    size: 16, 
                                    weight: 'bold',
                                    family: 'Arial'
                                },
                                formatter: function(value) {
                                    return value.toFixed(1);
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: subject === 'lgs_score' ? 500 : 20,
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.1)'
                                },
                                ticks: {
                                    font: { size: 13 },
                                    callback: function(value) {
                                        const suffix = subject === 'lgs_score' ? ' puan' : ' net';
                                        return value + suffix;
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                },
                                ticks: {
                                    font: { size: 14, weight: 'bold' },
                                    color: '#374151'
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
                
                document.getElementById('gradeLevelChartBox').style.display = 'block';
                
            } catch (error) {
                console.error('KarÅŸÄ±laÅŸtÄ±rma hatasÄ±:', error);
                showAlert('Grafik oluÅŸturulamadÄ±: ' + error.message, 'error');
            }
        }

        // YENÄ° SÄ°STEM 2: Ã–ÄŸrenci Detay GÃ¶rÃ¼nÃ¼mÃ¼
        let studentDetailCharts = {};
        
        async function loadStudentsForDetail() {
            const className = document.getElementById('studentDetailClassSelect').value;
            const select = document.getElementById('studentDetailSelect');
            
            select.disabled = true;
            select.innerHTML = '<option value="">YÃ¼kleniyor...</option>';
            
            if (!className) {
                select.innerHTML = '<option value="">Ã–nce sÄ±nÄ±f seÃ§in...</option>';
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/practice-exams/class/${className}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.exams || data.exams.length === 0) {
                    select.innerHTML = '<option value="">Bu sÄ±nÄ±fta deneme yok</option>';
                    select.disabled = true;
                    showAlert(`${className} sÄ±nÄ±fÄ±nda henÃ¼z deneme sÄ±navÄ± bulunmuyor.`, 'info');
                    return;
                }
                
                // Benzersiz Ã¶ÄŸrencileri al
                const uniqueStudents = [];
                const seenIds = new Set();
                
                data.exams.forEach(exam => {
                    if (!seenIds.has(exam.student_id)) {
                        seenIds.add(exam.student_id);
                        uniqueStudents.push({
                            id: exam.student_id,
                            name: exam.full_name
                        });
                    }
                });
                
                if (uniqueStudents.length === 0) {
                    select.innerHTML = '<option value="">Bu sÄ±nÄ±fta Ã¶ÄŸrenci yok</option>';
                    select.disabled = true;
                    showAlert(`${className} sÄ±nÄ±fÄ±nda Ã¶ÄŸrenci bulunmuyor.`, 'info');
                    return;
                }
                
                select.innerHTML = '<option value="">Ã–ÄŸrenci seÃ§in...</option>';
                uniqueStudents.sort((a, b) => a.name.localeCompare(b.name, 'tr'));
                
                uniqueStudents.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = student.name;
                    select.appendChild(option);
                });
                
                select.disabled = false;
                
            } catch (error) {
                console.error('Ã–ÄŸrenci yÃ¼kleme hatasÄ±:', error);
                select.innerHTML = '<option value="">Hata oluÅŸtu</option>';
                select.disabled = true;
                showAlert('Ã–ÄŸrenci listesi yÃ¼klenemedi: ' + error.message, 'error');
            }
        }

        async function showStudentDetail() {
            console.log('ğŸ”§ showStudentDetail Ã§aÄŸrÄ±ldÄ±');
            const studentId = document.getElementById('studentDetailSelect').value;
            console.log('SeÃ§ilen Ã¶ÄŸrenci ID:', studentId);
            
            if (!studentId) {
                alert('LÃ¼tfen bir Ã¶ÄŸrenci seÃ§in!');
                return;
            }
            
            try {
                console.log(`ğŸ“Š API Ã§aÄŸrÄ±sÄ±: /teacher/api/practice-exams/student/${studentId}`);
                const response = await fetch(`/teacher/api/practice-exams/student/${studentId}`);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('Ã–ÄŸrenci detay verisi:', data);
                
                if (!data.exams || data.exams.length === 0) {
                    alert('Bu Ã¶ÄŸrenci iÃ§in deneme verisi bulunamadÄ±!');
                    return;
                }
                
                const exams = data.exams;
                const studentName = data.student.full_name;
                
                document.getElementById('studentDetailName').textContent = studentName;
                
                // TÃ¼m grafikleri temizle
                Object.values(studentDetailCharts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                studentDetailCharts = {};
                
                // Grafikleri oluÅŸtur
                createStudentDetailCharts(exams);
                
                document.getElementById('studentDetailBox').style.display = 'block';
                
            } catch (error) {
                console.error('Ã–ÄŸrenci detay hatasÄ±:', error);
                showAlert('Grafik oluÅŸturulamadÄ±: ' + error.message, 'error');
            }
        }

        function createStudentDetailCharts(exams) {
            const examNumbers = exams.map(e => 'Deneme ' + e.exam_number);
            
            const turkceNets = exams.map(e => parseFloat(e.turkce_net));
            const matematikNets = exams.map(e => parseFloat(e.matematik_net));
            const fenNets = exams.map(e => parseFloat(e.fen_net));
            const sosyalNets = exams.map(e => parseFloat(e.sosyal_net));
            const ingilizceNets = exams.map(e => parseFloat(e.ingilizce_net));
            const dinNets = exams.map(e => parseFloat(e.din_net));
            const lgsScores = exams.map(e => parseFloat(e.lgs_score));
            
            // LGS Grafik
            studentDetailCharts.lgs = createBarChart('studentDetailLgsChart', examNumbers, lgsScores, 'LGS PuanÄ±', '#10b981', 500);
            
            // Ders grafikleri
            studentDetailCharts.turkce = createBarChart('studentDetailTurkceChart', examNumbers, turkceNets, 'TÃ¼rkÃ§e', '#ef4444', 20);
            studentDetailCharts.matematik = createBarChart('studentDetailMatematikChart', examNumbers, matematikNets, 'Matematik', '#3b82f6', 20);
            studentDetailCharts.fen = createBarChart('studentDetailFenChart', examNumbers, fenNets, 'Fen', '#10b981', 20);
            studentDetailCharts.sosyal = createBarChart('studentDetailSosyalChart', examNumbers, sosyalNets, 'Sosyal', '#f59e0b', 10);
            studentDetailCharts.ingilizce = createBarChart('studentDetailIngilizceChart', examNumbers, ingilizceNets, 'Ä°ngilizce', '#8b5cf6', 10);
            studentDetailCharts.din = createBarChart('studentDetailDinChart', examNumbers, dinNets, 'Din', '#ec4899', 10);
        }

        function createBarChart(canvasId, labels, data, title, color, maxValue) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            return new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: title,
                        data: data,
                        backgroundColor: data.map((val, i) => {
                            if (i === 0) return color + 'AA';
                            return val >= data[i-1] ? color : color + '55';
                        }),
                        borderColor: color,
                        borderWidth: 2,
                        borderRadius: 8,
                        barThickness: 50
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1200,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: title + (maxValue === 500 ? ' GeliÅŸimi' : ' Net GeliÅŸimi'),
                            font: { size: 16, weight: 'bold' },
                            color: '#374151'
                        },
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 13 }
                        },
                        datalabels: {
                            display: true,
                            align: 'end',
                            anchor: 'end',
                            offset: 4,
                            color: '#ffffff',
                            backgroundColor: color,
                            borderRadius: 4,
                            padding: {
                                top: 4,
                                bottom: 4,
                                left: 8,
                                right: 8
                            },
                            font: { 
                                size: 14, 
                                weight: 'bold',
                                family: 'Arial'
                            },
                            formatter: function(value) {
                                return value.toFixed(1);
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: maxValue,
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                font: { size: 12 },
                                stepSize: maxValue === 500 ? 100 : 5
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                font: { size: 12 }
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        // PDF Download FonksiyonlarÄ±
        let currentClassName = '';
        let currentStudentId = null;

        function downloadClassPDF() {
            if (!currentClassName) {
                alert('LÃ¼tfen Ã¶nce bir sÄ±nÄ±f seÃ§in!');
                return;
            }
            window.open(`/admin/api/practice-exams/report/class/${currentClassName}`, '_blank');
        }

        function downloadStudentPDF() {
            if (!currentStudentId) {
                alert('LÃ¼tfen Ã¶nce bir Ã¶ÄŸrenci seÃ§in!');
                return;
            }
            window.open(`/teacher/api/practice-exams/report/student/${currentStudentId}`, '_blank');
        }

        // =====================================================
        // DENEME SÄ°LME FONKSÄ°YONLARI
        // =====================================================
        let deleteExamStudents = [];
        
        async function loadStudentsForDelete() {
            const className = document.getElementById('deleteExamClassSelect').value;
            const studentSelect = document.getElementById('deleteExamStudentSelect');
            
            if (!className) {
                studentSelect.disabled = true;
                studentSelect.innerHTML = '<option value="">Ã–nce sÄ±nÄ±f seÃ§in...</option>';
                document.getElementById('deleteExamBox').style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/practice-exams/class-students/${className}`);
                const data = await response.json();
                
                if (data.students && data.students.length > 0) {
                    deleteExamStudents = data.students;
                    studentSelect.disabled = false;
                    studentSelect.innerHTML = '<option value="">Ã–ÄŸrenci seÃ§in...</option>';
                    
                    data.students.forEach(student => {
                        const option = document.createElement('option');
                        option.value = student.id;
                        option.textContent = student.full_name;
                        studentSelect.appendChild(option);
                    });
                } else {
                    studentSelect.disabled = true;
                    studentSelect.innerHTML = '<option value="">Bu sÄ±nÄ±fta Ã¶ÄŸrenci yok</option>';
                }
                
                document.getElementById('deleteExamBox').style.display = 'none';
            } catch (error) {
                console.error('Ã–ÄŸrenci listesi yÃ¼klenemedi:', error);
                showAlert('Ã–ÄŸrenci listesi yÃ¼klenemedi', 'error');
            }
        }
        
        async function loadExamsForDelete() {
            const studentId = document.getElementById('deleteExamStudentSelect').value;
            
            if (!studentId) {
                document.getElementById('deleteExamBox').style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/teacher/api/practice-exams/student/${studentId}`);
                const data = await response.json();
                
                const student = deleteExamStudents.find(s => s.id == studentId);
                const studentName = student ? student.full_name : 'Ã–ÄŸrenci';
                
                document.getElementById('deleteExamStudentName').textContent = studentName;
                
                const tbody = document.getElementById('deleteExamTableBody');
                tbody.innerHTML = '';
                
                if (data.exams && data.exams.length > 0) {
                    data.exams.forEach((exam, index) => {
                        const tr = document.createElement('tr');
                        tr.style.backgroundColor = index % 2 === 0 ? '#ffffff' : '#f8fafc';
                        tr.innerHTML = `
                            <td style="padding: 12px; text-align: center; font-weight: 600;">Deneme ${exam.exam_number}</td>
                            <td style="padding: 12px; text-align: center;">${parseFloat(exam.turkce_net).toFixed(1)}</td>
                            <td style="padding: 12px; text-align: center;">${parseFloat(exam.matematik_net).toFixed(1)}</td>
                            <td style="padding: 12px; text-align: center;">${parseFloat(exam.fen_net).toFixed(1)}</td>
                            <td style="padding: 12px; text-align: center;">${parseFloat(exam.sosyal_net).toFixed(1)}</td>
                            <td style="padding: 12px; text-align: center;">${parseFloat(exam.ingilizce_net).toFixed(1)}</td>
                            <td style="padding: 12px; text-align: center;">${parseFloat(exam.din_net).toFixed(1)}</td>
                            <td style="padding: 12px; text-align: center; font-weight: bold; color: #667eea;">${parseFloat(exam.lgs_score).toFixed(2)}</td>
                            <td style="padding: 12px; text-align: center;">
                                <button onclick="deletePracticeExam(${exam.id}, ${exam.exam_number}, '${studentName}')" 
                                        style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s;"
                                        onmouseover="this.style.background='#dc2626'" 
                                        onmouseout="this.style.background='#ef4444'">
                                    ğŸ—‘ï¸ Sil
                                </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    document.getElementById('deleteExamBox').style.display = 'block';
                } else {
                    tbody.innerHTML = '<tr><td colspan="9" style="padding: 20px; text-align: center; color: #6b7280;">Bu Ã¶ÄŸrencinin henÃ¼z deneme kaydÄ± yok</td></tr>';
                    document.getElementById('deleteExamBox').style.display = 'block';
                }
            } catch (error) {
                console.error('Deneme listesi yÃ¼klenemedi:', error);
                showAlert('Deneme listesi yÃ¼klenemedi', 'error');
            }
        }
        
        async function deletePracticeExam(examId, examNumber, studentName) {
            if (!confirm(`${studentName} adlÄ± Ã¶ÄŸrencinin ${examNumber}. denemesini silmek istediÄŸinize emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz!`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/api/practice-exams/delete/${examId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResultModal('success', 'Deneme Silindi', `${studentName} adlÄ± Ã¶ÄŸrencinin ${examNumber}. denemesi baÅŸarÄ±yla silindi.`);
                    loadExamsForDelete();
                } else {
                    showResultModal('error', 'Hata', data.error || 'Deneme silinirken bir hata oluÅŸtu');
                }
            } catch (error) {
                console.error('Deneme silme hatasÄ±:', error);
                showResultModal('error', 'Hata', 'Deneme silinirken bir hata oluÅŸtu');
            }
        }

        window.onload = async function() {
            if (await checkAuth()) {
                populateClasses();
            }
        };
    </script>
</body>
</html>
