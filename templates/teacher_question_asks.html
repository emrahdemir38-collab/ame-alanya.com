<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã–ÄŸrenci SorularÄ± - AMEO</title>
    <link rel="stylesheet" href="/static/css/admin-modern.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family), 'Segoe UI', sans-serif;
            background: var(--gray-50);
        }
        .header {
            background: var(--gradient-ocean);
            color: white;
            padding: 20px 24px;
            box-shadow: var(--shadow-lg);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 1.6em; font-weight: 700; }
        .btn-back {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.4);
            padding: 10px 22px;
            border-radius: var(--radius-lg);
            cursor: pointer;
            text-decoration: none;
            font-weight: 600;
            transition: all var(--transition-fast);
        }
        .btn-back:hover { background: rgba(255,255,255,0.3); transform: translateY(-1px); }
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h3 {
            color: #3b82f6;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        .stat-card p { color: #666; }
        
        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .filter-tab {
            flex: 1;
            padding: 12px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .filter-tab:hover { border-color: #3b82f6; }
        .filter-tab.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .question-list { margin-top: 20px; }
        .question-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f3f4f6;
        }
        .student-info {
            flex: 1;
        }
        .student-info h3 {
            color: #1f2937;
            margin-bottom: 8px;
        }
        .student-info p {
            color: #6b7280;
            font-size: 0.95em;
            margin: 4px 0;
        }
        .badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        .badge-pending {
            background: #fef3c7;
            color: #92400e;
        }
        .badge-answered {
            background: #d1fae5;
            color: #065f46;
        }
        .question-details {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .question-details p {
            margin: 10px 0;
            color: #374151;
        }
        .question-details strong {
            color: #1f2937;
        }
        .response-section {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .response-form {
            margin-top: 20px;
        }
        .response-form textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 1em;
            resize: vertical;
        }
        .response-form textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }
        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            margin-top: 15px;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-primary:hover { background: #2563eb; }
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #999;
        }
        .empty-state .icon {
            font-size: 5em;
            margin-bottom: 20px;
        }
        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: 1fr; }
            .question-header { flex-direction: column; }
            .filter-tabs { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>ğŸ’¬ Ã–ÄŸrenci SorularÄ±</h1>
                <a href="/teacher/dashboard" class="btn-back">â† Ana Sayfa</a>
            </div>
            <button onclick="openExamQuestionsModal()" 
                style="background: rgba(16, 185, 129, 0.9); color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2); transition: all 0.2s;"
                onmouseover="this.style.background='rgba(16, 185, 129, 1)'; this.style.transform='translateY(-2px)'" 
                onmouseout="this.style.background='rgba(16, 185, 129, 0.9)'; this.style.transform='translateY(0)'">
                ğŸ“„ Deneme SorularÄ±nÄ± GÃ¶r
            </button>
        </div>
    </div>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <h3 id="totalCount">0</h3>
                <p>Toplam Soru</p>
            </div>
            <div class="stat-card">
                <h3 id="pendingCount">0</h3>
                <p>Bekleyen</p>
            </div>
            <div class="stat-card">
                <h3 id="answeredCount">0</h3>
                <p>Cevaplanan</p>
            </div>
        </div>

        <div class="filter-tabs">
            <button class="filter-tab active" onclick="filterQuestions('all')">TÃ¼mÃ¼</button>
            <button class="filter-tab" onclick="filterQuestions('pending')">Bekleyenler</button>
            <button class="filter-tab" onclick="filterQuestions('answered')">Cevaplananlar</button>
        </div>

        <div id="questionList" class="question-list"></div>
        
        <div id="emptyState" class="empty-state" style="display:none;">
            <div class="icon">ğŸ’¬</div>
            <h3>HenÃ¼z soru yok</h3>
            <p>Ã–ÄŸrencilerinizden soru geldiÄŸinde burada gÃ¶rÃ¼ntÃ¼leyebilirsiniz.</p>
        </div>
    </div>

    <!-- Deneme SorularÄ±nÄ± GÃ¶rÃ¼ntÃ¼leme Modal -->
    <div id="examQuestionsModal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
        <div style="max-width: 900px; margin: 50px auto; background: white; border-radius: 10px; padding: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #111827;">ğŸ“„ Deneme SÄ±navÄ± SorularÄ±</h2>
                <button onclick="closeExamQuestionsModal()" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">Ã—</button>
            </div>
            
            <div id="examQuestionsContent">
                <p style="text-align: center; color: #9ca3af; padding: 40px;">YÃ¼kleniyor...</p>
            </div>
        </div>
    </div>

    <script>
        let allQuestions = [];
        let currentFilter = 'all';

        async function loadQuestions() {
            try {
                const response = await fetch('/api/question-asks/teacher/me');
                const data = await response.json();
                
                allQuestions = data.questions || [];
                
                document.getElementById('totalCount').textContent = data.total || 0;
                document.getElementById('pendingCount').textContent = data.pending || 0;
                document.getElementById('answeredCount').textContent = data.answered || 0;
                
                displayQuestions();
            } catch (error) {
                console.error('Sorular yÃ¼klenemedi:', error);
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        function filterQuestions(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(tab => tab.classList.remove('active'));
            event.currentTarget.classList.add('active');
            displayQuestions();
        }

        function displayQuestions() {
            let filtered = allQuestions;
            
            if (currentFilter === 'pending') {
                filtered = allQuestions.filter(q => q.status === 'pending');
            } else if (currentFilter === 'answered') {
                filtered = allQuestions.filter(q => q.status === 'answered');
            }
            
            const container = document.getElementById('questionList');
            const emptyState = document.getElementById('emptyState');
            
            if (filtered.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = filtered.map(q => renderQuestion(q)).join('');
        }

        function renderQuestion(q) {
            const isPending = q.status === 'pending';
            
            return `
                <div class="question-card">
                    <div class="question-header">
                        <div class="student-info">
                            <h3>${q.student_name}</h3>
                            <p>SÄ±nÄ±f: ${q.student_class || 'BelirtilmemiÅŸ'}</p>
                            <p style="font-size: 0.85em; color: #9ca3af; margin-top: 8px;">
                                ${new Date(q.created_at).toLocaleDateString('tr-TR', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </p>
                        </div>
                        <span class="badge badge-${q.status}">
                            ${isPending ? 'â³ Bekliyor' : 'âœ… CevaplandÄ±'}
                        </span>
                    </div>
                    
                    <div class="question-details">
                        <p><strong>ğŸ“ Deneme:</strong> ${q.exam_number}</p>
                        <p><strong>ğŸ“š Ders:</strong> ${q.subject}</p>
                        <p><strong>ğŸ”¢ Soru NumarasÄ±:</strong> ${q.question_number}</p>
                        <p><strong>â“ Neden:</strong> ${q.reason}</p>
                        ${q.student_note ? `
                            <div style="background: white; padding: 15px; border-radius: 6px; margin-top: 15px;">
                                <strong>ğŸ“Œ Ã–ÄŸrenci Notu:</strong>
                                <p style="margin-top: 10px; color: #4b5563;">${q.student_note}</p>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${isPending ? `
                        <div class="response-form">
                            <textarea 
                                id="response_${q.id}" 
                                placeholder="CevabÄ±nÄ±zÄ± buraya yazÄ±n..."
                            ></textarea>
                            <button class="btn btn-primary" onclick="submitResponse(${q.id})">
                                ğŸ“¤ Cevap GÃ¶nder
                            </button>
                        </div>
                    ` : `
                        <div class="response-section">
                            <strong>âœ¨ CevabÄ±nÄ±z:</strong>
                            <p style="margin-top: 10px; color: #374151;">${q.teacher_response}</p>
                            <p style="font-size: 0.85em; color: #6b7280; margin-top: 10px;">
                                ${new Date(q.answered_at).toLocaleDateString('tr-TR', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                            </p>
                        </div>
                    `}
                </div>
            `;
        }

        async function submitResponse(questionId) {
            const textarea = document.getElementById(`response_${questionId}`);
            const response = textarea.value.trim();
            
            if (!response) {
                alert('LÃ¼tfen cevap yazÄ±nÄ±z');
                return;
            }
            
            try {
                const result = await fetch(`/api/question-asks/${questionId}/respond`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ teacher_response: response })
                });
                
                const data = await result.json();
                
                if (result.ok) {
                    alert(data.message || 'CevabÄ±nÄ±z gÃ¶nderildi!');
                    loadQuestions();
                } else {
                    alert(data.error || 'Hata oluÅŸtu');
                }
            } catch (error) {
                console.error('GÃ¶nderme hatasÄ±:', error);
                alert('BaÄŸlantÄ± hatasÄ±');
            }
        }

        // Deneme SorularÄ±nÄ± GÃ¶rÃ¼ntÃ¼leme FonksiyonlarÄ±
        async function openExamQuestionsModal() {
            document.getElementById('examQuestionsModal').style.display = 'block';
            await loadExamQuestions();
        }

        function closeExamQuestionsModal() {
            document.getElementById('examQuestionsModal').style.display = 'none';
        }

        async function loadExamQuestions() {
            try {
                const response = await fetch('/api/exam-questions');
                const data = await response.json();
                
                const container = document.getElementById('examQuestionsContent');
                
                if (!data.questions || data.questions.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: #999;">
                            <div style="font-size: 4em; margin-bottom: 20px;">ğŸ“</div>
                            <h3>HenÃ¼z deneme sorusu yÃ¼klenmemiÅŸ</h3>
                            <p>Admin tarafÄ±ndan deneme sÄ±navÄ± sorularÄ± yÃ¼klendiÄŸinde burada gÃ¶rÃ¼necektir.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px;">
                        ${data.questions.map(q => `
                            <div style="background: #f9fafb; border-radius: 8px; padding: 20px; border: 1px solid #e5e7eb;">
                                <h3 style="color: #111827; margin-bottom: 10px;">${q.exam_name}</h3>
                                <p style="color: #6b7280; font-size: 0.9em; margin-bottom: 15px;">
                                    ${q.file_type === 'pdf' ? 'ğŸ“„ PDF DosyasÄ±' : 'ğŸ–¼ï¸ Resim DosyasÄ±'}
                                </p>
                                <p style="color: #9ca3af; font-size: 0.85em; margin-bottom: 15px;">
                                    ${new Date(q.created_at).toLocaleDateString('tr-TR')}
                                </p>
                                <a href="/api/exam-questions/${q.id}/file" target="_blank"
                                    style="display: block; text-align: center; background: #3b82f6; color: white; padding: 10px; border-radius: 5px; text-decoration: none; transition: background 0.2s;"
                                    onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                                    ğŸ‘ï¸ GÃ¶rÃ¼ntÃ¼le
                                </a>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('Sorular yÃ¼klenemedi:', error);
                document.getElementById('examQuestionsContent').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ef4444;">
                        âŒ Sorular yÃ¼klenirken hata oluÅŸtu
                    </div>
                `;
            }
        }

        // Modal dÄ±ÅŸÄ±na tÄ±klayÄ±nca kapat
        document.getElementById('examQuestionsModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeExamQuestionsModal();
            }
        });

        loadQuestions();
    </script>
</body>
</html>
