{% set breadcrumbs = [{'text': 'KullanÄ±cÄ± YÃ¶netimi', 'url': ''}] %}
{% extends "base_dashboard.html" %}

{% block title %}KullanÄ±cÄ± YÃ¶netimi{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/admin-modern.css">
<style>
    .dashboard-content {
        padding: 24px 28px;
    }
    
    .filter-bar {
        background: white;
        padding: 20px 24px;
        border-radius: var(--radius-xl);
        margin-bottom: 20px;
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
        align-items: center;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-100);
    }
    
    .filter-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .filter-group label {
        font-weight: 600;
        color: var(--gray-600);
        font-size: var(--font-size-sm);
        white-space: nowrap;
    }
    
    .search-wrapper {
        flex: 1;
        min-width: 280px;
        position: relative;
    }
    
    .search-wrapper input {
        width: 100%;
        padding: 12px 16px 12px 44px;
        border: 2px solid var(--gray-200);
        border-radius: var(--radius-lg);
        font-size: var(--font-size-sm);
        transition: all var(--transition-fast);
    }
    
    .search-wrapper input:focus {
        border-color: var(--primary-500);
        box-shadow: 0 0 0 4px var(--primary-100);
        outline: none;
    }
    
    .search-wrapper .search-icon {
        position: absolute;
        left: 14px;
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-400);
        font-size: 1.1rem;
    }
    
    .action-toolbar {
        background: white;
        padding: 16px 24px;
        border-radius: var(--radius-xl);
        margin-bottom: 20px;
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        align-items: center;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--gray-100);
    }
    
    .user-avatar-cell {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    
    .user-avatar-small {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.85rem;
        flex-shrink: 0;
    }
    
    .user-avatar-small.teacher {
        background: linear-gradient(135deg, var(--primary-400), var(--primary-600));
        color: white;
    }
    
    .user-avatar-small.student {
        background: linear-gradient(135deg, var(--success-400), var(--success-600));
        color: white;
    }
    
    .user-avatar-small.admin {
        background: linear-gradient(135deg, var(--warning-400), var(--warning-600));
        color: white;
    }
    
    .user-info-text {
        display: flex;
        flex-direction: column;
        min-width: 150px;
    }
    
    .user-info-name {
        font-weight: 600;
        color: var(--gray-800);
        font-size: 0.95rem;
        white-space: nowrap;
    }
    
    .user-info-username {
        font-size: 0.8rem;
        color: var(--gray-500);
    }
    
    .action-buttons {
        display: flex;
        gap: 8px;
    }
    
    .action-buttons .btn {
        padding: 6px 12px;
        font-size: 0.8rem;
    }
    
    .stats-mini {
        display: flex;
        gap: 16px;
        margin-bottom: 20px;
    }
    
    .stat-mini-card {
        background: white;
        padding: 16px 20px;
        border-radius: var(--radius-lg);
        display: flex;
        align-items: center;
        gap: 12px;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--gray-100);
        min-width: 160px;
    }
    
    .stat-mini-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }
    
    .stat-mini-value {
        font-size: 1.4rem;
        font-weight: 700;
        color: var(--gray-800);
    }
    
    .stat-mini-label {
        font-size: 0.75rem;
        color: var(--gray-500);
    }
    
    @media (max-width: 768px) {
        .dashboard-content {
            padding: 16px;
        }
        
        .filter-bar {
            flex-direction: column;
            align-items: stretch;
        }
        
        .search-wrapper {
            min-width: 100%;
        }
        
        .stats-mini {
            flex-wrap: wrap;
        }
        
        .stat-mini-card {
            flex: 1;
            min-width: 140px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-content">
    <!-- Page Header -->
    <div class="page-header-modern">
        <h1>ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi</h1>
        <p>Ã–ÄŸretmen ve Ã¶ÄŸrenci hesaplarÄ±nÄ± yÃ¶netin</p>
    </div>
    
    <!-- Stats Mini Cards -->
    <div class="stats-mini">
        <div class="stat-mini-card">
            <div class="stat-mini-icon" style="background: var(--primary-100); color: var(--primary-600);">ğŸ‘¥</div>
            <div>
                <div class="stat-mini-value" id="totalUsersCount">-</div>
                <div class="stat-mini-label">Toplam KullanÄ±cÄ±</div>
            </div>
        </div>
        <div class="stat-mini-card">
            <div class="stat-mini-icon" style="background: var(--info-100); color: var(--info-600);">ğŸ‘¨â€ğŸ«</div>
            <div>
                <div class="stat-mini-value" id="teacherCount">-</div>
                <div class="stat-mini-label">Ã–ÄŸretmen</div>
            </div>
        </div>
        <div class="stat-mini-card">
            <div class="stat-mini-icon" style="background: var(--success-100); color: var(--success-600);">ğŸ‘¨â€ğŸ“</div>
            <div>
                <div class="stat-mini-value" id="studentCount">-</div>
                <div class="stat-mini-label">Ã–ÄŸrenci</div>
            </div>
        </div>
    </div>
    
    <!-- Filter Bar -->
    <div class="filter-bar">
        <div class="filter-group">
            <label>ğŸ‘¥ Rol:</label>
            <select id="roleFilter" class="form-select" style="min-width: 150px;" onchange="filterUsers()">
                <option value="">TÃ¼mÃ¼</option>
                <option value="teacher">Ã–ÄŸretmen</option>
                <option value="student">Ã–ÄŸrenci</option>
            </select>
        </div>
        
        <div class="filter-group" id="classFilterGroup" style="display: none;">
            <label>ğŸ« SÄ±nÄ±f:</label>
            <select id="classFilter" class="form-select" style="min-width: 150px;" onchange="filterUsers()">
                <option value="">TÃ¼m SÄ±nÄ±flar</option>
            </select>
        </div>
        
        <div class="search-wrapper">
            <span class="search-icon">ğŸ”</span>
            <input type="text" id="searchInput" placeholder="Ä°sim, soyisim veya kullanÄ±cÄ± adÄ± ara..." oninput="filterUsers()">
        </div>
        
        <button class="btn btn-secondary btn-sm" onclick="resetFilters()">ğŸ”„ Temizle</button>
    </div>
    
    <!-- Action Toolbar -->
    <div class="action-toolbar">
        <button class="btn btn-primary" onclick="showCreateModal()">
            <span>â•</span> Yeni KullanÄ±cÄ±
        </button>
        <button class="btn btn-success" onclick="document.getElementById('excelFile').click()">
            <span>ğŸ“Š</span> Excel Ä°Ã§e Aktar
        </button>
        <input type="file" id="excelFile" accept=".xlsx,.xls" style="display:none" onchange="uploadExcel(this)">
        <button class="btn btn-secondary" onclick="downloadSampleExcel()">
            <span>ğŸ“¥</span> Ã–rnek Excel
        </button>
        <button class="btn btn-secondary" onclick="exportUsers()">
            <span>ğŸ“¤</span> DÄ±ÅŸa Aktar
        </button>
        <button class="btn btn-warning" onclick="document.getElementById('updateExcelFile').click()">
            <span>ğŸ”„</span> Toplu GÃ¼ncelle
        </button>
        <input type="file" id="updateExcelFile" accept=".xlsx" style="display:none" onchange="updateUsersFromExcel(this)">
        <button class="btn btn-info" onclick="resetAllPasswords()">
            <span>ğŸ”‘</span> TÃ¼m Åifreleri SÄ±fÄ±rla
        </button>
        <div style="flex: 1;"></div>
        <button class="btn btn-danger" id="deleteSelectedBtn" onclick="deleteSelectedUsers()" style="display:none">
            ğŸ—‘ï¸ SeÃ§ilenleri Sil (<span id="selectedCount">0</span>)
        </button>
        <button class="btn btn-danger" onclick="deleteAllUsers()">
            ğŸ—‘ï¸ TÃ¼mÃ¼nÃ¼ Sil
        </button>
    </div>

    <!-- Users Table -->
    <div class="table-container">
        <div class="table-header">
            <h2>ğŸ“‹ KullanÄ±cÄ± Listesi</h2>
            <span class="badge badge-secondary" id="filteredCount">0 kullanÄ±cÄ±</span>
        </div>
        
        <div id="loading" style="text-align: center; padding: 60px 20px; color: var(--gray-400);">
            <div class="loading-spinner" style="margin: 0 auto 16px;"></div>
            <p>KullanÄ±cÄ±lar yÃ¼kleniyor...</p>
        </div>
        
        <table class="table-modern" id="usersTable" style="display:none">
            <thead>
                <tr>
                    <th style="width: 50px;">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll(this.checked)" style="cursor: pointer; width: 18px; height: 18px;">
                    </th>
                    <th>KullanÄ±cÄ±</th>
                    <th>Rol</th>
                    <th>SÄ±nÄ±f</th>
                    <th>Numara</th>
                    <th style="text-align: right;">Ä°ÅŸlemler</th>
                </tr>
            </thead>
            <tbody id="usersBody"></tbody>
        </table>
    </div>
</div>

<!-- Create Modal -->
<div id="createModal" class="modal-overlay" onclick="if(event.target === this) closeModal()">
    <div class="modal-modern">
        <div class="modal-header">
            <h2>â• Yeni KullanÄ±cÄ± OluÅŸtur</h2>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>
        <form id="createForm">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label required">KullanÄ±cÄ± AdÄ±</label>
                    <input type="text" name="username" class="form-input" required placeholder="ornek_kullanici">
                </div>
                <div class="form-group">
                    <label class="form-label required">Åifre</label>
                    <input type="password" name="password" class="form-input" required placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div class="form-group">
                    <label class="form-label required">Ad Soyad</label>
                    <input type="text" name="full_name" class="form-input" required placeholder="Ahmet YÄ±lmaz">
                </div>
                <div class="form-group">
                    <label class="form-label required">Rol</label>
                    <select name="role" class="form-select" required onchange="toggleClassField(this.value)">
                        <option value="">SeÃ§iniz...</option>
                        <option value="teacher">Ã–ÄŸretmen</option>
                        <option value="student">Ã–ÄŸrenci</option>
                    </select>
                </div>
                <div class="form-group" id="classGroup" style="display:none">
                    <label class="form-label">SÄ±nÄ±f</label>
                    <select name="class_name" id="classSelect" class="form-select"></select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">Ä°ptal</button>
                <button type="submit" class="btn btn-primary">OluÅŸtur</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal-overlay" onclick="if(event.target === this) closeEditModal()">
    <div class="modal-modern">
        <div class="modal-header">
            <h2>âœï¸ KullanÄ±cÄ±yÄ± DÃ¼zenle</h2>
            <button class="modal-close" onclick="closeEditModal()">&times;</button>
        </div>
        <form id="editForm">
            <input type="hidden" name="user_id">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label required">KullanÄ±cÄ± AdÄ±</label>
                    <input type="text" name="username" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Yeni Åifre</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" name="password" id="editPassword" class="form-input" placeholder="DeÄŸiÅŸtirmek istemiyorsanÄ±z boÅŸ bÄ±rakÄ±n" style="flex: 1;">
                        <button type="button" class="btn btn-sm btn-secondary" onclick="fillDefaultPassword()" title="VarsayÄ±lan ÅŸifreyi yaz">ğŸ”‘</button>
                    </div>
                    <span class="form-helper">VarsayÄ±lan ÅŸifre: <strong id="defaultPasswordHint">-</strong> (kullanÄ±cÄ± adÄ±nÄ±n ilk 6 hanesi)</span>
                </div>
                <div class="form-group">
                    <label class="form-label required">Ad Soyad</label>
                    <input type="text" name="full_name" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label required">Rol</label>
                    <select name="role" class="form-select" required onchange="toggleEditClassField(this.value)">
                        <option value="teacher">Ã–ÄŸretmen</option>
                        <option value="student">Ã–ÄŸrenci</option>
                    </select>
                </div>
                <div class="form-group" id="editClassGroup" style="display:none">
                    <label class="form-label">SÄ±nÄ±f</label>
                    <select name="class_name" id="editClassSelect" class="form-select"></select>
                </div>
                <div class="form-group" id="editStudentNoGroup" style="display:none">
                    <label class="form-label">Okul NumarasÄ±</label>
                    <input type="text" name="student_no" id="editStudentNo" class="form-input" placeholder="Ã–rn: 1234">
                    <span class="form-helper">Excel toplu yÃ¼klemede eÅŸleÅŸtirme iÃ§in kullanÄ±lÄ±r</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Ä°ptal</button>
                <button type="submit" class="btn btn-primary">GÃ¼ncelle</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let users = [];
    let filteredUsers = [];

    function showToast(message, type = 'info') {
        const container = document.querySelector('.toast-container') || createToastContainer();
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <span style="font-size: 1.2rem;">${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}</span>
            <span style="flex: 1;">${message}</span>
        `;
        container.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
    }

    function createToastContainer() {
        const container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
        return container;
    }

    async function loadUsers() {
        try {
            const response = await fetch('/api/admin/users');
            const data = await response.json();
            users = data.users || [];
            
            const teachers = users.filter(u => u.role === 'teacher').length;
            const students = users.filter(u => u.role === 'student').length;
            
            document.getElementById('totalUsersCount').textContent = users.length;
            document.getElementById('teacherCount').textContent = teachers;
            document.getElementById('studentCount').textContent = students;
            
            const uniqueClasses = [...new Set(users
                .filter(u => u.class_name)
                .map(u => u.class_name)
                .sort())];
            
            const classOptions = uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('classFilter').innerHTML = '<option value="">TÃ¼m SÄ±nÄ±flar</option>' + classOptions;
            
            filteredUsers = users;
            renderUsers();
        } catch (error) {
            document.getElementById('loading').innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 16px;">ğŸ˜•</div>
                <p>YÃ¼kleme hatasÄ±: ${error.message}</p>
            `;
        }
    }

    function filterUsers() {
        const roleFilter = document.getElementById('roleFilter').value;
        const classFilter = document.getElementById('classFilter').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
        
        const classFilterGroup = document.getElementById('classFilterGroup');
        if (roleFilter === 'student') {
            classFilterGroup.style.display = 'flex';
        } else {
            classFilterGroup.style.display = 'none';
            document.getElementById('classFilter').value = '';
        }
        
        filteredUsers = users.filter(user => {
            if (roleFilter && user.role !== roleFilter) return false;
            if (classFilter && user.class_name !== classFilter) return false;
            
            if (searchTerm) {
                const username = (user.username || '').toLowerCase();
                const fullName = (user.full_name || '').toLowerCase();
                const className = (user.class_name || '').toLowerCase();
                
                if (!username.includes(searchTerm) && 
                    !fullName.includes(searchTerm) && 
                    !className.includes(searchTerm)) {
                    return false;
                }
            }
            return true;
        });
        
        renderUsers();
    }
    
    function resetFilters() {
        document.getElementById('roleFilter').value = '';
        document.getElementById('classFilter').value = '';
        document.getElementById('searchInput').value = '';
        document.getElementById('classFilterGroup').style.display = 'none';
        filteredUsers = users;
        renderUsers();
    }

    function renderUsers() {
        const tbody = document.getElementById('usersBody');
        const loading = document.getElementById('loading');
        const table = document.getElementById('usersTable');
        
        loading.style.display = 'none';
        table.style.display = 'table';
        
        document.getElementById('filteredCount').textContent = `${filteredUsers.length} kullanÄ±cÄ±`;
        
        if (filteredUsers.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 3rem; margin-bottom: 12px; opacity: 0.5;">ğŸ”</div>
                        <p style="color: var(--gray-500);">KullanÄ±cÄ± bulunamadÄ±</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        tbody.innerHTML = filteredUsers.map(user => `
            <tr>
                <td>
                    <input type="checkbox" class="user-checkbox" value="${user.id}" onchange="updateSelectedCount()" style="width: 18px; height: 18px; cursor: pointer;">
                </td>
                <td>
                    <div class="user-avatar-cell">
                        <div class="user-avatar-small ${user.role}">
                            ${getInitials(user.full_name)}
                        </div>
                        <div class="user-info-text">
                            <span class="user-info-name">${user.full_name || '-'}</span>
                            <span class="user-info-username">@${user.username || '-'}</span>
                        </div>
                    </div>
                </td>
                <td><span class="badge badge-${user.role === 'teacher' ? 'primary' : user.role === 'admin' ? 'warning' : 'success'}">${roleText(user.role)}</span></td>
                <td>${user.class_name || '-'}</td>
                <td>${user.student_no || '-'}</td>
                <td style="text-align: right;">
                    <div class="action-buttons" style="justify-content: flex-end;">
                        <button class="btn btn-sm btn-primary" onclick="editUser(${user.id})" title="DÃ¼zenle">âœï¸</button>
                        <button class="btn btn-sm btn-secondary" onclick="impersonateUser(${user.id})" title="GiriÅŸ Yap">ğŸ‘¤</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})" title="Sil">ğŸ—‘ï¸</button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    function getInitials(name) {
        if (!name) return '?';
        const parts = name.split(' ');
        if (parts.length >= 2) {
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }
        return name.substring(0, 2).toUpperCase();
    }

    function roleText(role) {
        const roles = { admin: 'Admin', teacher: 'Ã–ÄŸretmen', student: 'Ã–ÄŸrenci' };
        return roles[role] || role;
    }

    function toggleSelectAll(checked) {
        document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = checked);
        updateSelectedCount();
    }

    function updateSelectedCount() {
        const count = document.querySelectorAll('.user-checkbox:checked').length;
        document.getElementById('selectedCount').textContent = count;
        document.getElementById('deleteSelectedBtn').style.display = count > 0 ? 'inline-flex' : 'none';
    }

    async function showCreateModal() {
        await loadClasses();
        document.getElementById('createModal').classList.add('show');
    }

    function closeModal() {
        document.getElementById('createModal').classList.remove('show');
        document.getElementById('createForm').reset();
        document.getElementById('classGroup').style.display = 'none';
    }

    async function loadClasses() {
        try {
            const response = await fetch('/admin/api/classes');
            const data = await response.json();
            const classes = data.classes || [];
            
            const options = classes.map(c => `<option value="${c.class_name}">${c.class_name}</option>`).join('');
            document.getElementById('classSelect').innerHTML = '<option value="">SeÃ§iniz...</option>' + options;
            document.getElementById('editClassSelect').innerHTML = '<option value="">SeÃ§iniz...</option>' + options;
        } catch (error) {
            console.error('SÄ±nÄ±flar yÃ¼klenirken hata:', error);
        }
    }

    function toggleClassField(role) {
        document.getElementById('classGroup').style.display = role === 'student' ? 'block' : 'none';
    }

    function toggleEditClassField(role) {
        document.getElementById('editClassGroup').style.display = role === 'student' ? 'block' : 'none';
        document.getElementById('editStudentNoGroup').style.display = role === 'student' ? 'block' : 'none';
    }

    document.getElementById('createForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        
        try {
            const response = await fetch('/api/admin/users', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            
            if (result.success) {
                showToast('KullanÄ±cÄ± baÅŸarÄ±yla oluÅŸturuldu!', 'success');
                closeModal();
                loadUsers();
            } else {
                showToast('Hata: ' + result.error, 'error');
            }
        } catch (error) {
            showToast('Ä°stek hatasÄ±: ' + error.message, 'error');
        }
    });

    let currentEditingUsername = '';
    
    async function editUser(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        await loadClasses();
        
        const form = document.getElementById('editForm');
        form.user_id.value = user.id;
        form.username.value = user.username || '';
        form.full_name.value = user.full_name || '';
        form.role.value = user.role || 'student';
        form.class_name.value = user.class_name || '';
        form.student_no.value = user.student_no || '';
        form.password.value = '';
        
        currentEditingUsername = user.username || '';
        const defaultPwd = currentEditingUsername.substring(0, 6);
        document.getElementById('defaultPasswordHint').textContent = defaultPwd || '-';
        
        toggleEditClassField(user.role);
        document.getElementById('editModal').classList.add('show');
    }
    
    function fillDefaultPassword() {
        const defaultPwd = currentEditingUsername.substring(0, 6);
        document.getElementById('editPassword').value = defaultPwd;
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.remove('show');
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);
        const userId = data.user_id;
        delete data.user_id;
        
        if (!data.password) delete data.password;
        
        try {
            const response = await fetch(`/api/admin/users/${userId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            
            if (result.success) {
                showToast('KullanÄ±cÄ± baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
                closeEditModal();
                loadUsers();
            } else {
                showToast('Hata: ' + result.error, 'error');
            }
        } catch (error) {
            showToast('Ä°stek hatasÄ±: ' + error.message, 'error');
        }
    });

    async function deleteUser(userId) {
        if (!confirm('Bu kullanÄ±cÄ±yÄ± silmek istediÄŸinizden emin misiniz?')) return;
        
        try {
            const response = await fetch(`/api/admin/users/${userId}`, { method: 'DELETE' });
            const result = await response.json();
            
            if (result.success) {
                showToast('KullanÄ±cÄ± silindi!', 'success');
                loadUsers();
            } else {
                showToast('Hata: ' + result.error, 'error');
            }
        } catch (error) {
            showToast('Ä°stek hatasÄ±: ' + error.message, 'error');
        }
    }

    async function deleteSelectedUsers() {
        const checkboxes = document.querySelectorAll('.user-checkbox:checked');
        const userIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
        
        if (userIds.length === 0) return;
        if (!confirm(`${userIds.length} kullanÄ±cÄ±yÄ± silmek istediÄŸinizden emin misiniz?`)) return;
        
        try {
            const response = await fetch('/api/admin/users/bulk-delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_ids: userIds })
            });
            const result = await response.json();
            
            if (result.success) {
                showToast(`${userIds.length} kullanÄ±cÄ± silindi!`, 'success');
                document.getElementById('selectAll').checked = false;
                loadUsers();
            } else {
                showToast('Hata: ' + result.error, 'error');
            }
        } catch (error) {
            showToast('Ä°stek hatasÄ±: ' + error.message, 'error');
        }
    }

    async function impersonateUser(userId) {
        if (!confirm('Bu kullanÄ±cÄ± olarak giriÅŸ yapmak istiyor musunuz?')) return;
        
        try {
            const response = await fetch(`/api/admin/impersonate/${userId}`, { method: 'POST' });
            const result = await response.json();
            
            if (result.success) {
                window.location.href = result.redirect;
            } else {
                showToast('Hata: ' + result.error, 'error');
            }
        } catch (error) {
            showToast('Ä°stek hatasÄ±: ' + error.message, 'error');
        }
    }

    async function uploadExcel(input) {
        const file = input.files[0];
        if (!file) return;
        
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            showToast('Dosya yÃ¼kleniyor...', 'info');
            const response = await fetch('/api/admin/users/import', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            
            if (result.success) {
                if (result.error_count > 0) {
                    showUploadResultModal(result);
                } else {
                    showToast(`${result.success_count} kullanÄ±cÄ± baÅŸarÄ±yla eklendi!`, 'success');
                }
                loadUsers();
            } else {
                showToast('Hata: ' + result.error, 'error');
            }
        } catch (error) {
            showToast('Ä°stek hatasÄ±: ' + error.message, 'error');
        }
        
        input.value = '';
    }
    
    function showUploadResultModal(result) {
        const existingModal = document.getElementById('uploadResultModal');
        if (existingModal) existingModal.remove();
        
        const modal = document.createElement('div');
        modal.id = 'uploadResultModal';
        modal.style.cssText = `
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); display: flex; align-items: center;
            justify-content: center; z-index: 10000;
        `;
        
        const errorList = result.errors && result.errors.length > 0 
            ? result.errors.map(e => `<li style="padding: 8px 0; border-bottom: 1px solid #eee;">${e}</li>`).join('')
            : '<li>Detay yok</li>';
        
        modal.innerHTML = `
            <div style="background: white; border-radius: 16px; max-width: 600px; width: 90%;
                        max-height: 80vh; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <div style="padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <h3 style="margin: 0; font-size: 1.3rem;">ğŸ“Š Toplu YÃ¼kleme Sonucu</h3>
                </div>
                <div style="padding: 20px;">
                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <div style="flex: 1; padding: 15px; background: #d4edda; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #155724;">${result.success_count}</div>
                            <div style="color: #155724;">BaÅŸarÄ±lÄ±</div>
                        </div>
                        <div style="flex: 1; padding: 15px; background: #f8d7da; border-radius: 10px; text-align: center;">
                            <div style="font-size: 2rem; font-weight: bold; color: #721c24;">${result.error_count}</div>
                            <div style="color: #721c24;">BaÅŸarÄ±sÄ±z</div>
                        </div>
                    </div>
                    <div style="background: #fff3cd; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>âš ï¸ AÅŸaÄŸÄ±daki satÄ±rlar yÃ¼klenemedi:</strong>
                    </div>
                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px;">
                        <ul style="list-style: none; padding: 0; margin: 0; font-size: 0.9rem;">
                            ${errorList}
                        </ul>
                    </div>
                </div>
                <div style="padding: 15px 20px; background: #f8f9fa; text-align: right; border-top: 1px solid #eee;">
                    <button onclick="document.getElementById('uploadResultModal').remove()" 
                            style="padding: 10px 25px; background: #667eea; color: white; border: none;
                                   border-radius: 8px; cursor: pointer; font-weight: 600;">
                        Tamam
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    }

    function downloadSampleExcel() {
        window.open('/api/admin/users/sample-excel', '_blank');
    }

    function exportUsers() {
        window.open('/api/admin/users/export', '_blank');
    }

    async function updateUsersFromExcel(input) {
        if (!input.files || !input.files[0]) return;
        
        const file = input.files[0];
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            showToast('Excel yÃ¼kleniyor...', 'info');
            
            const response = await fetch('/api/admin/users/update-bulk', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                // SonuÃ§ modalÄ± gÃ¶ster
                const modal = document.createElement('div');
                modal.id = 'updateResultModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                
                modal.innerHTML = `
                    <div style="background: white; border-radius: 16px; max-width: 500px; width: 90%; box-shadow: 0 20px 50px rgba(0,0,0,0.3);">
                        <div style="padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 16px 16px 0 0;">
                            <h3 style="margin: 0; font-size: 1.3rem;">ğŸ”„ Toplu GÃ¼ncelleme Sonucu</h3>
                        </div>
                        <div style="padding: 20px; white-space: pre-line; font-size: 0.95rem; line-height: 1.8;">
                            ${result.message}
                        </div>
                        <div style="padding: 15px 20px; background: #f8f9fa; text-align: right; border-top: 1px solid #eee;">
                            <button onclick="document.getElementById('updateResultModal').remove(); loadUsers();" 
                                    style="padding: 10px 25px; background: #667eea; color: white; border: none;
                                           border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Tamam
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        loadUsers();
                    }
                });
            } else {
                showToast('Hata: ' + result.error, 'error');
            }
        } catch (error) {
            showToast('Ä°stek hatasÄ±: ' + error.message, 'error');
        }
        
        input.value = '';
    }

    async function resetAllPasswords() {
        if (!confirm('ğŸ”‘ TÃ¼m kullanÄ±cÄ±larÄ±n ÅŸifreleri sÄ±fÄ±rlanacak.\n\nHer kullanÄ±cÄ±nÄ±n ÅŸifresi, kullanÄ±cÄ± adÄ±nÄ±n ilk 6 hanesi olacak.\n\nDevam etmek istiyor musunuz?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/admin/users/reset-all-passwords', { method: 'POST' });
            const result = await response.json();
            
            if (result.success) {
                showToast(`${result.reset_count} kullanÄ±cÄ±nÄ±n ÅŸifresi sÄ±fÄ±rlandÄ±!`, 'success');
            } else {
                showToast('Hata: ' + result.error, 'error');
            }
        } catch (error) {
            showToast('Ä°stek hatasÄ±: ' + error.message, 'error');
        }
    }

    async function deleteAllUsers() {
        if (!confirm('âš ï¸ UYARI: TÃ¼m kullanÄ±cÄ±larÄ± SÄ°LECEKSÄ°NÄ°Z (Admin hariÃ§).\nBu iÅŸlem geri alÄ±namaz!\n\nDevam etmek istiyor musunuz?')) {
            return;
        }
        
        if (!confirm('ğŸ’€ Son uyarÄ±: TÃœM VERÄ° SÄ°LÄ°NECEK!\n\nEmin misiniz?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/admin/users/delete-all', { method: 'DELETE' });
            const result = await response.json();
            
            if (result.success) {
                showToast(`${result.deleted_count} kullanÄ±cÄ± silindi!`, 'success');
                loadUsers();
            } else {
                showToast('Hata: ' + result.error, 'error');
            }
        } catch (error) {
            showToast('Ä°stek hatasÄ±: ' + error.message, 'error');
        }
    }

    loadUsers();
</script>
{% endblock %}
