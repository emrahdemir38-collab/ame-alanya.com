{% extends "base_dashboard.html" %}

{% block title %}Karne Analizi{% endblock %}

{% block content %}
<style>
    .page-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .page-header {
        background: white;
        padding: 25px 30px;
        border-radius: 16px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }
    
    .page-title {
        font-size: 1.8em;
        color: #1f2937;
        margin-bottom: 5px;
    }
    
    .page-subtitle {
        color: #6b7280;
        font-size: 0.95em;
    }
    
    .analysis-grid {
        display: grid;
        gap: 20px;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    }
    
    .analysis-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .analysis-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    
    .card-icon {
        font-size: 3rem;
        margin-bottom: 16px;
    }
    
    .card-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 8px;
    }
    
    .card-desc {
        color: #6b7280;
        font-size: 0.95rem;
    }
    
    .exam-select-section {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }
    
    .section-title {
        font-size: 1.2rem;
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 16px;
    }
    
    .exams-list {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 20px;
    }
    
    .exam-checkbox {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        background: #f3f4f6;
        border-radius: 8px;
        cursor: pointer;
    }
    
    .exam-checkbox:hover {
        background: #e5e7eb;
    }
    
    .exam-checkbox input {
        width: 18px;
        height: 18px;
    }
    
    .action-btn {
        padding: 14px 28px;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        border: none;
        color: white;
        transition: transform 0.2s;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
    }
    
    .btn-error-report {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    
    .btn-progress {
        background: linear-gradient(135deg, #8b5cf6, #7c3aed);
    }
    
    .btn-outcome {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }
    
    .actions-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }
    
    .loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
    }
    
    .empty-icon {
        font-size: 4rem;
        margin-bottom: 16px;
    }
    
    .result-section {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        margin-top: 20px;
        display: none;
    }
    
    .result-section.active {
        display: block;
    }
</style>

<div class="page-container">
    <div class="page-header">
        <h1 class="page-title">ðŸ“ˆ Karne Analizi</h1>
        <p class="page-subtitle">SÄ±nav performansÄ±nÄ± incele ve geliÅŸim raporlarÄ±nÄ± gÃ¶rÃ¼ntÃ¼le</p>
    </div>
    
    <div class="exam-select-section">
        <h2 class="section-title">SÄ±navlarÄ±nÄ±z</h2>
        <div id="examsList" class="exams-list">
            <div class="loading">YÃ¼kleniyor...</div>
        </div>
        
        <div class="actions-row">
            <button class="action-btn btn-progress" onclick="showProgressAnalysis()">
                ðŸ“ˆ GeliÅŸim Analizi
            </button>
            <button class="action-btn btn-outcome" onclick="showOutcomeAnalysis()">
                ðŸŽ¯ KazanÄ±m Analizi
            </button>
            <button class="action-btn" style="background: linear-gradient(135deg, #10b981, #059669);" onclick="showPriorityTopics()">
                ðŸ”¥ Ã–ncelikli Konular
            </button>
        </div>
    </div>
    
    <div id="priorityResult" class="result-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 class="section-title" style="margin: 0;">ðŸ”¥ Ã–ncelikli Konular (En Ã‡ok Hata YapÄ±lan)</h2>
            <button onclick="downloadPriorityPDF()" class="action-btn btn-error-report" style="padding: 10px 20px; font-size: 0.9rem;">
                ðŸ“„ PDF Ä°ndir
            </button>
        </div>
        <div id="priorityContent"></div>
    </div>
    
    <div id="progressResult" class="result-section">
        <h2 class="section-title">ðŸ“ˆ GeliÅŸim Analizi</h2>
        <div id="progressContent"></div>
    </div>
    
    <div id="outcomeResult" class="result-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 class="section-title" style="margin: 0;">ðŸŽ¯ KazanÄ±m Analizi</h2>
            <button onclick="downloadOutcomePDF()" class="action-btn btn-outcome" style="padding: 10px 20px; font-size: 0.9rem;">
                ðŸ“„ PDF Ä°ndir
            </button>
        </div>
        <div id="outcomeContent"></div>
    </div>
</div>

<script>
let myExams = [];

document.addEventListener('DOMContentLoaded', loadMyExams);

function hideAllResults() {
    document.querySelectorAll('.result-section').forEach(section => {
        section.classList.remove('active');
    });
}

async function loadMyExams() {
    const container = document.getElementById('examsList');
    
    try {
        const response = await fetch('/admin/report-cards/student/my-reports');
        if (!response.ok) {
            throw new Error('API hatasÄ±');
        }
        const data = await response.json();
        
        myExams = Array.isArray(data) ? data : (data.report_cards || []);
        
        if (myExams.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">ðŸ“‹</div>
                    <h3>HenÃ¼z sÄ±nav kaydÄ±nÄ±z bulunmuyor</h3>
                    <p>Karne yÃ¼klendiÄŸinde burada gÃ¶rÃ¼necek</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = myExams.map(exam => `
            <label class="exam-checkbox">
                <input type="checkbox" class="exam-cb" value="${exam.id || exam.report_card_id}" checked>
                ${exam.exam_name}
            </label>
        `).join('');
        
    } catch (error) {
        console.error('Load error:', error);
        container.innerHTML = '<p style="color: #dc2626;">YÃ¼klenirken hata oluÅŸtu</p>';
    }
}

function getSelectedExams() {
    return Array.from(document.querySelectorAll('.exam-cb:checked')).map(cb => parseInt(cb.value));
}

function downloadErrorReport() {
    const selectedExams = getSelectedExams();
    
    if (selectedExams.length === 0) {
        alert('En az bir sÄ±nav seÃ§in');
        return;
    }
    
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/admin/report-cards/student/error-report-pdf';
    form.target = '_blank';
    
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'report_card_ids';
    input.value = selectedExams.join(',');
    form.appendChild(input);
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
}

async function showProgressAnalysis() {
    const selectedExams = getSelectedExams();
    
    if (selectedExams.length < 2) {
        alert('GeliÅŸim analizi iÃ§in en az 2 sÄ±nav seÃ§in');
        return;
    }
    
    hideAllResults();
    const resultSection = document.getElementById('progressResult');
    const content = document.getElementById('progressContent');
    
    resultSection.classList.add('active');
    content.innerHTML = '<div class="loading">Analiz yapÄ±lÄ±yor...</div>';
    
    try {
        const response = await fetch('/admin/report-cards/api/student-progress');
        const data = await response.json();
        
        if (data.error) {
            content.innerHTML = `<p style="color: #dc2626;">${data.error}</p>`;
            return;
        }
        
        const exams = data.exams || [];
        let html = '<div style="overflow-x: auto;">';
        html += '<table style="width: 100%; border-collapse: collapse;">';
        html += '<thead><tr style="background: #f3f4f6;">';
        html += '<th style="padding: 12px; text-align: left;">SÄ±nav</th>';
        html += '<th style="padding: 12px; text-align: center;">Toplam Net</th>';
        html += '<th style="padding: 12px; text-align: center;">YÃ¼zdelik</th>';
        html += '<th style="padding: 12px; text-align: center;">LGS Puan</th>';
        html += '</tr></thead><tbody>';
        
        exams.forEach((p, i) => {
            const change = i > 0 ? (p.total_net - exams[i-1].total_net) : 0;
            const changeIcon = change > 0 ? 'ðŸ“ˆ' : (change < 0 ? 'ðŸ“‰' : 'âž¡ï¸');
            
            html += `<tr style="border-bottom: 1px solid #e5e7eb;">
                <td style="padding: 12px;">${p.exam_name}</td>
                <td style="padding: 12px; text-align: center; font-weight: 600;">${p.total_net?.toFixed(1) || 0} ${changeIcon}</td>
                <td style="padding: 12px; text-align: center;">%${p.percentile || '-'}</td>
                <td style="padding: 12px; text-align: center;">${p.lgs_score?.toFixed(1) || '-'}</td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('Progress error:', error);
        content.innerHTML = '<p style="color: #dc2626;">Analiz yapÄ±lÄ±rken hata oluÅŸtu</p>';
    }
}

async function showOutcomeAnalysis() {
    hideAllResults();
    const resultSection = document.getElementById('outcomeResult');
    const content = document.getElementById('outcomeContent');
    
    resultSection.classList.add('active');
    content.innerHTML = '<div class="loading">KazanÄ±m analizi yapÄ±lÄ±yor...</div>';
    
    try {
        const response = await fetch('/admin/report-cards/api/student-outcomes');
        const data = await response.json();
        
        if (data.error) {
            content.innerHTML = `<p style="color: #dc2626;">${data.error}</p>`;
            return;
        }
        
        const subjects = data.subjects || {};
        let html = '';
        
        const subjectNames = {
            'turkce': 'TÃ¼rkÃ§e',
            'matematik': 'Matematik',
            'fen': 'Fen Bilimleri',
            'inkilap': 'Ä°nkÄ±lap Tarihi',
            'din': 'Din KÃ¼ltÃ¼rÃ¼',
            'ingilizce': 'Ä°ngilizce'
        };
        
        for (const [subject, outcomes] of Object.entries(subjects)) {
            html += `<div style="margin-bottom: 24px;">`;
            html += `<h3 style="color: #3b82f6; margin-bottom: 12px;">${subjectNames[subject] || subject}</h3>`;
            
            const weakOutcomes = outcomes.filter(o => o.success_rate < 50);
            const strongOutcomes = outcomes.filter(o => o.success_rate >= 80);
            
            if (weakOutcomes.length > 0) {
                html += `<div style="background: #fef2f2; padding: 12px; border-radius: 8px; margin-bottom: 8px;">`;
                html += `<strong style="color: #dc2626;">GeliÅŸtirilmesi Gereken (${weakOutcomes.length}):</strong>`;
                html += `<ul style="margin: 8px 0 0 20px;">`;
                weakOutcomes.slice(0, 5).forEach(o => {
                    html += `<li>${o.outcome_text || o.outcome_code} - %${o.success_rate?.toFixed(0) || 0}</li>`;
                });
                html += `</ul></div>`;
            }
            
            if (strongOutcomes.length > 0) {
                html += `<div style="background: #f0fdf4; padding: 12px; border-radius: 8px;">`;
                html += `<strong style="color: #16a34a;">GÃ¼Ã§lÃ¼ Alanlar (${strongOutcomes.length}):</strong>`;
                html += `<ul style="margin: 8px 0 0 20px;">`;
                strongOutcomes.slice(0, 5).forEach(o => {
                    html += `<li>${o.outcome_text || o.outcome_code} - %${o.success_rate?.toFixed(0) || 0}</li>`;
                });
                html += `</ul></div>`;
            }
            
            html += `</div>`;
        }
        
        if (!html) {
            html = '<p style="color: #6b7280;">KazanÄ±m verisi bulunamadÄ±</p>';
        }
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('Outcome error:', error);
        content.innerHTML = '<p style="color: #dc2626;">KazanÄ±m analizi yapÄ±lÄ±rken hata oluÅŸtu</p>';
    }
}

async function showPriorityTopics() {
    hideAllResults();
    const resultSection = document.getElementById('priorityResult');
    const content = document.getElementById('priorityContent');
    
    resultSection.classList.add('active');
    content.innerHTML = '<div class="loading">Ã–ncelikli konular analiz ediliyor...</div>';
    
    try {
        const response = await fetch('/admin/report-cards/api/student-priority-topics');
        const data = await response.json();
        
        if (data.error) {
            content.innerHTML = `<p style="color: #dc2626;">${data.error}</p>`;
            return;
        }
        
        const bySubject = data.by_subject || {};
        const priorityList = data.priority_list || [];
        
        let html = '';
        
        if (priorityList.length === 0) {
            content.innerHTML = '<p style="color: #6b7280;">HenÃ¼z yeterli veri bulunamadÄ±</p>';
            return;
        }
        
        html += '<div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 16px; border-radius: 12px; margin-bottom: 20px;">';
        html += '<h3 style="color: #92400e; margin-bottom: 12px;">ðŸŽ¯ Birinci Ã–ncelikli Konular</h3>';
        html += '<p style="color: #78350f; font-size: 0.9rem; margin-bottom: 12px;">Bu konularda en Ã§ok hata yaptÄ±nÄ±z. Ã–ncelikli Ã§alÄ±ÅŸmanÄ±z Ã¶nerilir:</p>';
        html += '<ol style="margin-left: 20px;">';
        
        priorityList.slice(0, 10).forEach((topic, i) => {
            const priority = i < 3 ? 'ðŸ”´' : (i < 6 ? 'ðŸŸ ' : 'ðŸŸ¡');
            html += `<li style="margin-bottom: 8px;">
                <strong>${priority} ${topic.subject_name}</strong>: ${topic.outcome_text} 
                <span style="background: #dc2626; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; margin-left: 8px;">${topic.total_errors} hata</span>
            </li>`;
        });
        
        html += '</ol></div>';
        
        html += '<h3 style="color: #1f2937; margin-bottom: 16px;">ðŸ“Š Ders BazlÄ± Hata DaÄŸÄ±lÄ±mÄ±</h3>';
        
        const sortedSubjects = Object.entries(bySubject).sort((a, b) => b[1].total_errors - a[1].total_errors);
        
        for (const [subject, subjectData] of sortedSubjects) {
            if (subjectData.total_errors === 0) continue;
            
            html += `<div style="background: white; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin-bottom: 16px;">`;
            html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">`;
            html += `<h4 style="color: #3b82f6; margin: 0;">${subjectData.name}</h4>`;
            html += `<span style="background: #fef2f2; color: #dc2626; padding: 4px 12px; border-radius: 20px; font-weight: 600;">Toplam ${subjectData.total_errors} hata</span>`;
            html += `</div>`;
            
            html += `<table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">`;
            html += `<thead><tr style="background: #f3f4f6;">
                <th style="padding: 8px; text-align: left;">KazanÄ±m</th>
                <th style="padding: 8px; text-align: center; width: 80px;">YanlÄ±ÅŸ</th>
                <th style="padding: 8px; text-align: center; width: 80px;">BoÅŸ</th>
                <th style="padding: 8px; text-align: center; width: 80px;">Toplam</th>
            </tr></thead><tbody>`;
            
            subjectData.topics.slice(0, 10).forEach(topic => {
                if (topic.total_errors === 0) return;
                html += `<tr style="border-bottom: 1px solid #e5e7eb;">
                    <td style="padding: 8px;"><code style="background: #e5e7eb; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem;">${topic.outcome_code}</code> ${topic.outcome_text}</td>
                    <td style="padding: 8px; text-align: center; color: #dc2626;">${topic.wrong_count}</td>
                    <td style="padding: 8px; text-align: center; color: #6b7280;">${topic.blank_count}</td>
                    <td style="padding: 8px; text-align: center; font-weight: 600;">${topic.total_errors}</td>
                </tr>`;
            });
            
            html += `</tbody></table></div>`;
        }
        
        content.innerHTML = html;
        
    } catch (error) {
        console.error('Priority topics error:', error);
        content.innerHTML = '<p style="color: #dc2626;">Ã–ncelikli konular analizi yapÄ±lÄ±rken hata oluÅŸtu</p>';
    }
}

function downloadPriorityPDF() {
    window.open('/admin/report-cards/student/priority-topics-pdf', '_blank');
}

function downloadOutcomePDF() {
    window.open('/admin/report-cards/student/outcome-analysis-pdf', '_blank');
}
</script>
{% endblock %}
