{% extends "base_dashboard.html" %}

{% block title %}Ã–ÄŸretmen-SÄ±nÄ±f Atama{% endblock %}

{% block content %}
<nav class="breadcrumb-nav">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/admin/dashboard">Ana Sayfa</a></li>
        <li class="breadcrumb-item active">Ã–ÄŸretmen-SÄ±nÄ±f Atama</li>
    </ol>
</nav>

<div style="max-width: 1200px; margin: 0 auto;">
    <div style="background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <h2 style="margin-bottom: 20px; color: #374151;">ğŸ‘¨â€ğŸ« Ã–ÄŸretmen-SÄ±nÄ±f Atama YÃ¶netimi</h2>
        
        <div id="alert" style="display: none; padding: 12px; border-radius: 5px; margin-bottom: 15px;"></div>
        
        <!-- Ã–ÄŸretmen SeÃ§imi -->
        <div style="margin-bottom: 25px; padding: 20px; background: #f9fafb; border-radius: 8px;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #374151;">
                Ã–ÄŸretmen SeÃ§
            </label>
            <select id="teacherSelect" 
                style="width: 100%; padding: 12px; border: 2px solid #d1d5db; border-radius: 6px; font-size: 1em;"
                onchange="loadTeacherClasses()">
                <option value="">Ã–ÄŸretmen seÃ§iniz...</option>
            </select>
        </div>

        <!-- SÄ±nÄ±f Atama BÃ¶lÃ¼mÃ¼ -->
        <div id="classAssignSection" style="display: none;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                <!-- Sol: AtanmÄ±ÅŸ SÄ±nÄ±flar -->
                <div style="background: #ecfdf5; padding: 20px; border-radius: 8px; border: 2px solid #10b981;">
                    <h3 style="margin-bottom: 15px; color: #059669; font-size: 1.1em;">
                        âœ… AtanmÄ±ÅŸ SÄ±nÄ±flar
                    </h3>
                    <div id="assignedClasses" style="min-height: 200px;">
                        <p style="text-align: center; color: #6b7280; padding: 20px;">Ã–ÄŸretmen seÃ§iniz</p>
                    </div>
                </div>

                <!-- SaÄŸ: Mevcut SÄ±nÄ±flar -->
                <div style="background: #eff6ff; padding: 20px; border-radius: 8px; border: 2px solid #3b82f6;">
                    <h3 style="margin-bottom: 15px; color: #2563eb; font-size: 1.1em;">
                        ğŸ“š SÄ±nÄ±f Listesi
                    </h3>
                    <div id="availableClasses" style="min-height: 200px;">
                        <p style="text-align: center; color: #6b7280; padding: 20px;">YÃ¼kleniyor...</p>
                    </div>
                </div>
            </div>

            <!-- Toplu Atama Butonu -->
            <div style="text-align: center; margin-top: 20px;">
                <button onclick="assignSelectedClasses()" 
                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 14px 35px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 1em; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);">
                    â• SeÃ§ili SÄ±nÄ±flarÄ± Ata
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .class-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        margin: 4px;
        border-radius: 6px;
        font-weight: 500;
        font-size: 0.95em;
    }
    
    .class-badge.assigned {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
    }
    
    .class-badge.available {
        background: #dbeafe;
        color: #1e40af;
        border: 1px solid #3b82f6;
    }
    
    .class-badge button {
        background: none;
        border: none;
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 1.1em;
        transition: background 0.2s;
    }
    
    .class-badge.assigned button:hover {
        background: #fca5a5;
    }
    
    .class-badge.available button:hover {
        background: #86efac;
    }
    
    .class-checkbox {
        display: flex;
        align-items: center;
        padding: 10px;
        margin: 5px 0;
        border-radius: 6px;
        cursor: pointer;
        transition: background 0.2s;
    }
    
    .class-checkbox:hover {
        background: #f3f4f6;
    }
    
    .class-checkbox input {
        margin-right: 10px;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    @media (max-width: 768px) {
        div[style*="grid-template-columns"] {
            grid-template-columns: 1fr !important;
        }
    }
</style>

<script>
let currentTeacherId = null;
let allClasses = [];
let teacherClasses = [];

// Ã–ÄŸretmenleri yÃ¼kle
async function loadTeachers() {
    try {
        const response = await fetch('/api/admin/users');
        const data = await response.json();
        
        const teachers = data.users.filter(u => u.role === 'teacher');
        const select = document.getElementById('teacherSelect');
        
        select.innerHTML = '<option value="">Ã–ÄŸretmen seÃ§iniz...</option>';
        
        teachers.forEach(teacher => {
            const option = document.createElement('option');
            option.value = teacher.id;
            option.textContent = `${teacher.full_name} (${teacher.username})`;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Ã–ÄŸretmenler yÃ¼klenemedi:', error);
        showAlert('Ã–ÄŸretmenler yÃ¼klenirken hata oluÅŸtu', 'error');
    }
}

// TÃ¼m sÄ±nÄ±flarÄ± yÃ¼kle
async function loadAllClasses() {
    try {
        const response = await fetch('/admin/api/classes');
        const data = await response.json();
        allClasses = data.classes || [];
        updateClassLists();
    } catch (error) {
        console.error('SÄ±nÄ±flar yÃ¼klenemedi:', error);
        showAlert('SÄ±nÄ±flar yÃ¼klenirken hata oluÅŸtu', 'error');
    }
}

// Ã–ÄŸretmenin atanmÄ±ÅŸ sÄ±nÄ±flarÄ±nÄ± yÃ¼kle
async function loadTeacherClasses() {
    const teacherId = document.getElementById('teacherSelect').value;
    
    if (!teacherId) {
        document.getElementById('classAssignSection').style.display = 'none';
        return;
    }
    
    currentTeacherId = teacherId;
    document.getElementById('classAssignSection').style.display = 'block';
    
    try {
        const response = await fetch(`/api/admin/teacher-classes/${teacherId}`);
        const data = await response.json();
        
        teacherClasses = data.classes || [];
        updateClassLists();
    } catch (error) {
        console.error('Ã–ÄŸretmen sÄ±nÄ±flarÄ± yÃ¼klenemedi:', error);
        showAlert('Ã–ÄŸretmen sÄ±nÄ±flarÄ± yÃ¼klenirken hata oluÅŸtu', 'error');
    }
}

// SÄ±nÄ±f listelerini gÃ¼ncelle
function updateClassLists() {
    const assignedDiv = document.getElementById('assignedClasses');
    const availableDiv = document.getElementById('availableClasses');
    
    const assignedClassNames = teacherClasses.map(c => c.class_name);
    
    // AtanmÄ±ÅŸ sÄ±nÄ±flar
    if (teacherClasses.length === 0) {
        assignedDiv.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">HenÃ¼z sÄ±nÄ±f atanmamÄ±ÅŸ</p>';
    } else {
        let html = '';
        teacherClasses.forEach(cls => {
            html += `
                <span class="class-badge assigned">
                    ${cls.class_name}
                    <button onclick="removeClass('${cls.class_name}')" title="KaldÄ±r">âŒ</button>
                </span>
            `;
        });
        assignedDiv.innerHTML = html;
    }
    
    // Mevcut sÄ±nÄ±flar (atanmayanlar)
    const availableClasses = allClasses.filter(c => !assignedClassNames.includes(c.class_name));
    
    if (availableClasses.length === 0) {
        availableDiv.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">TÃ¼m sÄ±nÄ±flar atanmÄ±ÅŸ</p>';
    } else {
        let html = '';
        availableClasses.forEach(cls => {
            html += `
                <label class="class-checkbox">
                    <input type="checkbox" value="${cls.class_name}" class="class-select-cb">
                    <span>${cls.class_name}</span>
                </label>
            `;
        });
        availableDiv.innerHTML = html;
    }
}

// SeÃ§ili sÄ±nÄ±flarÄ± ata
async function assignSelectedClasses() {
    if (!currentTeacherId) {
        showAlert('Ã–nce bir Ã¶ÄŸretmen seÃ§in', 'error');
        return;
    }
    
    const checkboxes = document.querySelectorAll('.class-select-cb:checked');
    const classNames = Array.from(checkboxes).map(cb => cb.value);
    
    if (classNames.length === 0) {
        showAlert('LÃ¼tfen en az bir sÄ±nÄ±f seÃ§in', 'error');
        return;
    }
    
    try {
        const response = await fetch('/api/admin/teacher-classes/assign', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                teacher_id: parseInt(currentTeacherId),
                class_names: classNames
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert(`${classNames.length} sÄ±nÄ±f baÅŸarÄ±yla atandÄ±`, 'success');
            await loadTeacherClasses();
        } else {
            showAlert(data.error || 'SÄ±nÄ±f atama baÅŸarÄ±sÄ±z', 'error');
        }
    } catch (error) {
        console.error('SÄ±nÄ±f atama hatasÄ±:', error);
        showAlert('SÄ±nÄ±f atama sÄ±rasÄ±nda hata oluÅŸtu', 'error');
    }
}

// SÄ±nÄ±f atamasÄ±nÄ± kaldÄ±r
async function removeClass(className) {
    if (!confirm(`${className} sÄ±nÄ±fÄ±nÄ± bu Ã¶ÄŸretmenden kaldÄ±rmak istediÄŸinize emin misiniz?`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/admin/teacher-classes/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                teacher_id: parseInt(currentTeacherId),
                class_name: className
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert('SÄ±nÄ±f atamasÄ± kaldÄ±rÄ±ldÄ±', 'success');
            await loadTeacherClasses();
        } else {
            showAlert(data.error || 'SÄ±nÄ±f kaldÄ±rma baÅŸarÄ±sÄ±z', 'error');
        }
    } catch (error) {
        console.error('SÄ±nÄ±f kaldÄ±rma hatasÄ±:', error);
        showAlert('SÄ±nÄ±f kaldÄ±rma sÄ±rasÄ±nda hata oluÅŸtu', 'error');
    }
}

// Alert gÃ¶ster
function showAlert(message, type) {
    const alertDiv = document.getElementById('alert');
    alertDiv.textContent = message;
    alertDiv.style.display = 'block';
    
    if (type === 'success') {
        alertDiv.style.background = '#d1fae5';
        alertDiv.style.color = '#065f46';
        alertDiv.style.border = '1px solid #10b981';
    } else {
        alertDiv.style.background = '#fee2e2';
        alertDiv.style.color = '#991b1b';
        alertDiv.style.border = '1px solid #ef4444';
    }
    
    setTimeout(() => {
        alertDiv.style.display = 'none';
    }, 5000);
}

// Sayfa yÃ¼klendiÄŸinde
document.addEventListener('DOMContentLoaded', () => {
    loadTeachers();
    loadAllClasses();
});
</script>

{% endblock %}
