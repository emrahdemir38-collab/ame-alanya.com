<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SÄ±nav Raporu - AMEO</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; }
        .header { background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .btn-secondary { background: #6b7280; color: white; }
        .btn-info { background: #3b82f6; color: white; }
        .container { max-width: 1600px; margin: 20px auto; padding: 0 20px; }
        
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: white; border-radius: 10px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .summary-card h3 { color: #6b7280; font-size: 0.9em; margin-bottom: 10px; text-transform: uppercase; }
        .summary-card .value { font-size: 2.5em; font-weight: bold; color: #1f2937; }
        .summary-card.success .value { color: #10b981; }
        .summary-card.warning .value { color: #f59e0b; }
        .summary-card.danger .value { color: #ef4444; }
        
        .students-table { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead th { background: #f3f4f6; padding: 15px; text-align: left; font-weight: 600; color: #374151; border-bottom: 2px solid #e5e7eb; }
        tbody td { padding: 15px; border-bottom: 1px solid #e5e7eb; color: #4b5563; }
        tbody tr:hover { background: #f9fafb; }
        
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.85em; font-weight: 500; display: inline-block; }
        .status-completed { background: #d1fae5; color: #065f46; }
        .status-not-submitted { background: #fee2e2; color: #991b1b; }
        
        .score-cell { font-weight: bold; font-size: 1.1em; }
        .score-high { color: #10b981; }
        .score-medium { color: #f59e0b; }
        .score-low { color: #ef4444; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto; }
        .modal.show { display: block; }
        .modal-content { background: white; max-width: 900px; margin: 30px auto; padding: 30px; border-radius: 15px; }
        
        .questions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 20px; }
        .question-box { border: 2px solid #e5e7eb; border-radius: 8px; padding: 12px; text-align: center; }
        .question-box.correct { border-color: #10b981; background: #d1fae5; }
        .question-box.wrong { border-color: #ef4444; background: #fee2e2; }
        .question-box.empty { border-color: #f59e0b; background: #fef3c7; }
        .question-box .q-num { font-weight: bold; font-size: 0.9em; color: #6b7280; }
        .question-box .q-answer { font-size: 1.2em; font-weight: bold; margin: 5px 0; }
        .question-box .q-correct { font-size: 0.85em; color: #6b7280; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“Š SÄ±nav Raporu</h1>
        <div>
            <button class="btn btn-secondary" onclick="history.back()">â† Geri</button>
        </div>
    </div>

    <div class="container">
        <div id="examInfo" style="background:white; padding:20px; border-radius:10px; margin-bottom:20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
            <h2 id="examTitle" style="color:#1f2937; margin-bottom:10px;">YÃ¼kleniyor...</h2>
            <p id="examDetails" style="color:#6b7280;"></p>
        </div>

        <div class="summary-cards">
            <div class="summary-card">
                <h3>ğŸ“š Toplam Ã–ÄŸrenci</h3>
                <div class="value" id="totalStudents">-</div>
            </div>
            <div class="summary-card success">
                <h3>âœ… Tamamlanan</h3>
                <div class="value" id="completedCount">-</div>
            </div>
            <div class="summary-card danger">
                <h3>âŒ YapÄ±lmayan</h3>
                <div class="value" id="notSubmittedCount">-</div>
            </div>
            <div class="summary-card warning">
                <h3>ğŸ“Š Ortalama Puan</h3>
                <div class="value" id="avgScore">-</div>
            </div>
        </div>

        <div class="students-table">
            <h2 style="margin-bottom:20px; color:#1f2937;">ğŸ‘¥ Ã–ÄŸrenci DetaylarÄ±</h2>
            <table>
                <thead>
                    <tr>
                        <th>Ã–ÄŸrenci AdÄ±</th>
                        <th>Durum</th>
                        <th>Puan</th>
                        <th>âœ… DoÄŸru</th>
                        <th>âŒ YanlÄ±ÅŸ</th>
                        <th>âšª BoÅŸ</th>
                        <th>Teslim ZamanÄ±</th>
                        <th>Ä°ÅŸlem</th>
                    </tr>
                </thead>
                <tbody id="studentsTableBody">
                    <tr><td colspan="8" style="text-align:center; padding:40px; color:#6b7280;">YÃ¼kleniyor...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <div id="modalDetails" class="modal">
        <div class="modal-content">
            <h2 id="modalStudentName" style="margin-bottom:20px; color:#1f2937;">Ã–ÄŸrenci DetaylarÄ±</h2>
            <div style="background:#f3f4f6; padding:15px; border-radius:8px; margin-bottom:20px;">
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap:15px;">
                    <div>
                        <strong style="color:#6b7280;">Puan:</strong>
                        <div id="modalScore" style="font-size:1.5em; font-weight:bold; color:#1f2937;">-</div>
                    </div>
                    <div>
                        <strong style="color:#6b7280;">âœ… DoÄŸru:</strong>
                        <div id="modalCorrect" style="font-size:1.5em; font-weight:bold; color:#10b981;">-</div>
                    </div>
                    <div>
                        <strong style="color:#6b7280;">âŒ YanlÄ±ÅŸ:</strong>
                        <div id="modalWrong" style="font-size:1.5em; font-weight:bold; color:#ef4444;">-</div>
                    </div>
                    <div>
                        <strong style="color:#6b7280;">âšª BoÅŸ:</strong>
                        <div id="modalEmpty" style="font-size:1.5em; font-weight:bold; color:#f59e0b;">-</div>
                    </div>
                </div>
            </div>
            
            <h3 style="margin-bottom:15px; color:#1f2937;">Soru DetaylarÄ±</h3>
            <div id="questionsGrid" class="questions-grid">
                <!-- Sorular buraya yÃ¼klenecek -->
            </div>
            
            <button class="btn btn-secondary" id="btnCloseModal" style="margin-top:25px; width:100%;">Kapat</button>
        </div>
    </div>

    <script>
        const examId = window.location.pathname.split('/')[3];
        const modal = document.getElementById('modalDetails');
        const btnClose = document.getElementById('btnCloseModal');
        
        btnClose.addEventListener('click', () => modal.classList.remove('show'));
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.classList.remove('show');
        });
        
        async function loadReport() {
            try {
                const response = await fetch(`/teacher/api/exams/${examId}/report`);
                if (!response.ok) throw new Error('Rapor yÃ¼klenemedi');
                
                const data = await response.json();
                
                // SÄ±nav bilgilerini gÃ¶ster
                document.getElementById('examTitle').textContent = data.exam.title;
                document.getElementById('examDetails').textContent = 
                    `SÄ±nÄ±f: ${data.exam.target_class} | Soru SayÄ±sÄ±: ${data.exam.question_count} | BaÅŸlangÄ±Ã§: ${new Date(data.exam.start_time).toLocaleString('tr-TR')}`;
                
                // Ã–zet kartlarÄ±
                document.getElementById('totalStudents').textContent = data.summary.total_students;
                document.getElementById('completedCount').textContent = data.summary.completed;
                document.getElementById('notSubmittedCount').textContent = data.summary.not_submitted;
                document.getElementById('avgScore').textContent = data.summary.average_score ? data.summary.average_score.toFixed(1) : '0.0';
                
                // Ã–ÄŸrenci tablosu
                const tbody = document.getElementById('studentsTableBody');
                tbody.innerHTML = '';
                
                if (data.students.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px; color:#6b7280;">Ã–ÄŸrenci bulunamadÄ±</td></tr>';
                    return;
                }
                
                data.students.forEach(student => {
                    const tr = document.createElement('tr');
                    
                    const statusBadge = student.status === 'completed' 
                        ? '<span class="status-badge status-completed">âœ… TamamlandÄ±</span>'
                        : '<span class="status-badge status-not-submitted">âŒ YapÄ±lmadÄ±</span>';
                    
                    let scoreClass = 'score-low';
                    if (student.score >= 70) scoreClass = 'score-high';
                    else if (student.score >= 50) scoreClass = 'score-medium';
                    
                    const detailBtn = student.status === 'completed'
                        ? `<button class="btn btn-info" style="padding:6px 15px; font-size:0.85em;" onclick='showDetails(${JSON.stringify(student)})'>ğŸ“‹ Detay</button>`
                        : '-';
                    
                    tr.innerHTML = `
                        <td><strong>${student.student_name}</strong></td>
                        <td>${statusBadge}</td>
                        <td class="score-cell ${scoreClass}">${student.score.toFixed(1)}</td>
                        <td style="color:#10b981; font-weight:bold;">${student.correct_count}</td>
                        <td style="color:#ef4444; font-weight:bold;">${student.wrong_count}</td>
                        <td style="color:#f59e0b; font-weight:bold;">${student.empty_count}</td>
                        <td>${student.submitted_at ? new Date(student.submitted_at).toLocaleString('tr-TR') : '-'}</td>
                        <td>${detailBtn}</td>
                    `;
                    tbody.appendChild(tr);
                });
                
            } catch (error) {
                console.error('Hata:', error);
                alert('âŒ Rapor yÃ¼klenirken hata oluÅŸtu: ' + error.message);
            }
        }
        
        function showDetails(student) {
            document.getElementById('modalStudentName').textContent = student.student_name;
            document.getElementById('modalScore').textContent = student.score.toFixed(1);
            document.getElementById('modalCorrect').textContent = student.correct_count;
            document.getElementById('modalWrong').textContent = student.wrong_count;
            document.getElementById('modalEmpty').textContent = student.empty_count;
            
            const grid = document.getElementById('questionsGrid');
            grid.innerHTML = '';
            
            student.question_details.forEach(q => {
                const box = document.createElement('div');
                box.className = `question-box ${q.status}`;
                box.innerHTML = `
                    <div class="q-num">Soru ${q.question_number}</div>
                    <div class="q-answer">${q.student_answer}</div>
                    <div class="q-correct">DoÄŸru: ${q.correct_answer}</div>
                `;
                grid.appendChild(box);
            });
            
            modal.classList.add('show');
        }
        
        loadReport();
    </script>
</body>
</html>
